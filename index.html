<!DOCTYPE  html>
<html>
<head>
  <title>NF VisSynth</title>
  <script src="glfx.js"></script>
  <script src="video.js"></script>
</head>
<body>
  <style>
    html,body,canvas{
      width: 100%;
      height: 100%;
      padding: 0px;
      margin: 0px;
      overflow: hidden;
      background-color: #000;
    }
  </style>

  <script>
    function get_cookie(cookie_name)
    {
      var cookie = document.cookie;
      var cookies = cookie.split(';');
      for (var i=0; i<cookies.length; ++i)
      {
        parts = cookies[i].split('=');
        if (parts[0].trim()==cookie_name)
        {
          return parts[1].trim();
        }
      }

    }

    function set_cookie(key,value)
    {
      document.cookie = key+'='+value+';path=/;expires=Thu, 1 Jan 2095 00:00:00 GMT;';
    }
  </script>
  <script>
    
    
    var w=640, h=480;    

    // WebcamVidja video and effects streaming engine
    var c = wcvj.webcam('c', {canvas: true, glfx: true});

    var time=0; // running time
    
    // pre-rendering callback (filter setup)
    var animation=function(){

      // time repeats after 2 periods of PI
      time=(time+.01)%(2*Math.PI);
      c.setFilter(chain(time));
    };
    
    
    var put=function(url,data){
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open('PUT',url,true);  
      xmlHttp.send(data);
    }
    
    // post-rendering-callback (preview setup)
    var preview_enabled=false;
    var get_preview=function()
    {
      if(!preview_enabled) return;
      var pixels=c.canvas.toDataURL('image/jpeg');
    
      put('/preview',pixels);
      
      preview_enabled=false;
    }
    
    c.setCallback(animation,get_preview);

    document.body.appendChild(c.canvas);


    // command polling for UI server
    var poll_command=function()
    {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open('GET', '/command', true);
      xmlHttp.onreadystatechange = function () {
        if (xmlHttp.readyState == 4) {
          setTimeout(function(){
            poll_command();
          },100);
          var js=xmlHttp.responseText;
          console.log(js);
          if(js) 
          {
            var result=window.eval(js);
            if(result){
              put('/result',JSON.stringify(result));
            }
          }
        }
      };
      xmlHttp.send(null);
    }
    poll_command();



    // global functions for UI use
   
    function setChain(_chain_src){
      chain_src=_chain_src;
      var src='var _=function(t){return '+chain_src+';};_';
      chain=eval(src);
    }
    setChain("[]");
       
    function preview()
    {
      preview_enabled=true;
    }
    
  </script>

</body>
</html>
