<!DOCTYPE  html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>NF VisSynth MCP</title>
  <script src="jquery-2.1.4.js"></script>
</head>
<body style="font-size: 20px;">


  <style>
  
   /* general element styles */

   body,html{   
      font-family: sans-serif;    
      margin: 0px;
      padding: 0px;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none; 
  }
  
  
.ui{
  display: inline-block;
  border: 4px solid #000;
  margin: 30px;
}
.channel{
  display: inline-block;
  text-align: center;
}
.knob{
  width: 100px;
  height: 100px;
  border-radius: 50px;
  border: 5px dashed #888;
  color: #fff;
  background-color: #000;
  margin: 10px;
  text-align:center;
  font-size: 15px;
}
.display
{
  font-family: monospace;
  font-size: 22px;
  font-weight: bold;
  background-color: #f90;
  margin: 5px;
  padding: 5px;
}

  </style>




<div class=ui style='width:auto;'>
  <div>VIS SYNTH BOX MARK I</div>
  <pre class=display></pre>
  <div class=channel>
    <div class=knob id=knob_patch></div>
  </div>
  <div class=channel>
    <div class=knob id=knob_layer></div>
  </div>
  <div class=channel>
    <div class=knob id=knob_param></div>
  </div>
  <div class=channel>
    <div class=knob id=knob_value></div>
  </div>
</div>


  <span id=stats></span>
  

  <script>
  
    // get session url, if any
    var session_url='/';
    if(document.location.hash)
      session_url+=document.location.hash.substring(1)+'_';

    var put=function(url,data)
    {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.responseType='text';
      xmlHttp.open('PUT',url,true);
      xmlHttp.send(data);
    }
    
    var get=function(url,callback)
    {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.responseType='text';
      xmlHttp.open('GET',url,true);
      xmlHttp.onreadystatechange=function()
      {
        if(xmlHttp.readyState!=4) return;
        callback(xmlHttp.responseText);      
      }
      xmlHttp.send(null);      
    }
    
    // send command to remote server
    function send(command)
    {
      put('/feeds'+session_url+'command',command+';\n');
    }

    function restart()
    {
      send('document.location.reload()');
      setTimeout(updateChain,500); // TODO get rid of wait (race condition prone)
    }

    /* the undo history. updated by frequent save() calls */
    var undo_history=[];
    
    /* save all chains to server and undo_history */
    var save=function()
    {
      var json=JSON.stringify(chains,null,' ');
      put('/saves'+session_url+'chains.json',json);
      undo_history.push(json);
      
      console.log('Saved.');
      
      savetimeout=false;
    }
          


    var savetimeout=false;
    var updateChain=function(event,ui)
    {
      if(savetimeout) clearTimeout(savetimeout);
      savetimeout=setTimeout(save,1000);
            
      var full_chain=pre_chain.concat(chain,post_chain);                              

      // send out to control server
      send('setChain('+JSON.stringify(full_chain)+')');
    }

        
    var load=function(json)
    {
      if(!json) return;
      chains=JSON.parse(json);

      // add pre- and post chain to legacy chains 
      if(typeof(chains[0][0])=='string') // if first chain is a named one, we have a legacy save.
        chains.unshift([{"effect": "capture","device": 0}],[]);

      pre_chain=chains.shift();
      post_chain=chains.shift();      
      
      main_ui();
    }


    // build list of effects
    // an effect defines all parameters the UI will show and their default values.
    // the parameters must match the filter functions arguments in order, as they do not take named parameters.
    // additional attributes can be defined for the UI:
    // inputs: n  denotes the number of inputs of the effect. It is expected to pop n-1 stack items! Defaults to 1 if not defined.
    // outputs: n  denotes the number of outputs of the effect. It is expected to push n-1 stack items! Defaults to 1 if not defined.
    // feedback_input:1 denotes the effect reads the feedback buffer from the last frame
    // feedback_output:1 denotes the effect writes the feedback buffer for the next frame
    var effects={
      'select_audio':{inputs:0,outputs:0, args:{audio_device:0.0}},
      'map_video':{inputs:0,outputs:0, args:{source_device:0.0, target_device:0.0}},
      'fps':{inputs:0,outputs:0,args:{fps:25.0}},
      'type_byte':{inputs:0,outputs:0},
      'type_float':{inputs:0,outputs:0},
      'resolution':{inputs:0,outputs:0,args:{x:640,y:480}},
      'capture':{inputs:0,args:{device:0}},
      'video':{inputs:0,args:{url:"test.mp4",play_sound:0.0}},
      'image':{inputs:0,args:{url:"test.jpg"}},
      'matte':{inputs:0, args:{rgb:{type:'rgba', r:0.0,g:1.0,b:1.0,a:1.0}}},
      'noise':{inputs:0,args:{seed:{type:'osc',f:0.1,a:1.0,p:0.0,o:0.0,waveform:'saw'}}},
      'grating':{inputs:0,args:{size:100.0,angle:0.0,ax:1.0,fx:1.0,ay:1.0,fy:1.0}},
      'superellipse':{inputs:0,args:{size:100.0,angle:0.0,a:1.0,b:1.0,m:18.0,n1:0.9,n2:-1.0,n3:-1.0}},
      'rectangle':{inputs:0, args:{color:{type:'rgba', r:1.0,g:1.0,b:1.0,a:1.0},x:0.0,y:0.0,width:0.2,height:0.2,angle:0.0}},
      'polygon_matte':{inputs:0, args:{color:{type:'rgba', r:0.0,g:1.0,b:1.0,a:1.0},sides:6.0,x:0.0,y:0.0,size:0.5,angle:0.0,aspect:1.0}},
      'waveform':{inputs:0},
      'vectorscope':{inputs: 0,args:{size: 2.0, intensity:0.3, linewidth:1.0}},
      'spectrogram':{inputs:0},
      'preview':{},
      'feedbackOut':{args:{blend:0.7,clear_on_switch:0.0}},
      'feedbackIn':{},
      'stack_push':{outputs:2},
      'stack_swap':{inputs: 2,outputs:2},
      'blend':{inputs: 2,args:{alpha:0.5, factor: 1.0}},
      'blend_alpha':{inputs: 2},
      'multiply':{inputs: 2},
      'blend_mask':{inputs: 3},
      'chroma_key':{inputs: 2,args:{color:{type:'rgb',r:0.2,g:0.7,b:0.4},threshold:0.2,feather: 0.1}},
      'luma_key':{inputs: 2,args:{threshold:0.5,feather: 0.05}},
      'displacement':{inputs: 2,args:{strength:0.05}},
      'mesh_displacement':{inputs: 2,args:{sx:0.0,sy:0.0,sz:0.1,anglex:1.0,angley:0.5,anglez:0.0}},
      'patch_displacement':{inputs: 2,args:{sx:0.0,sy:0.0,sz:0.1,anglex:0.0,angley:0.3,anglez:0.0,scale:2.0,pixelate:0.0}},
      'particles':{inputs: 2,args:{anglex:0.0,angley:0.3,anglez:0.0,size: 15.0, strength:0.5,homing:0.01,noise:1.0,displacement:0.0}},
      'transform':{args:{x:0.0,y:0.0,scale:1.0,angle:0.0}},
      'perspective':{args:{perspective:{type:'perspective', x1:-0.75,y1:-0.75, x2:-0.75,y2:0.75,x3:0.75,y3:-0.75,x4:0.75,y4:0.75}}},
      'strobe':{args:{period:10.0}},
      'timeshift':{args:{time:{type:'osc',f:200.0,a:12.5,p:0.0,o:12.5},clear_on_switch:0.0}},
      'vibrance':{args:{strength:1.0}},
      'brightnessContrast':{args:{brightness:0.0,contrast:0.0}},
      'threshold':{args:{threshold:0.5,feather:0.0,r0:0.0,g0:0.0,b0:0.0,r1:1.0,g1:1.0,b1:1.0}},
      'hueSaturation':{args:{hue:0.0,saturation:0.0}},
      'levels':{args:{min:0.0,gamma:1.0,max:1.0, r_min:0.0,g_min:0.0,b_min:0.0, r_gamma:1.0,g_gamma:1.0,b_gamma:1.0, r_max:1.0,g_max:1.0,b_max:1.0}},
      'invert':{},
      'absolute':{},
      'rainbow':{},      
      'noalpha':{},
      'color':{args:{strength:0.5,rgb:{type:'rgb', r:0.0,g:1.0,b:1.0}}},
      'posterize':{args:{steps:4.0}},
      'posterize_hue':{args:{hue:4.0,brightness:255.0}},
      'mirror_x':{},
      'mirror_y':{},
      'motion':{args:{threshold:0.3,interval:1.,damper:0.99}},
      'polygon':{args:{sides:6.0,x:0.0,y:0.0,size:0.5,angle:0.0,aspect:1.0}},
      'kaleidoscope':{args:{sides:5.0,angle:{type:'osc',f:5.0,a:1.0,p:0.0,o:0.0},angle2:{type:'osc',f:2.0,a:1.0,p:0.0,o:0.0}}},
      'tile':{args:{divisions:2.0,center:{type:'pos',x:0.0,y:0.0}}},
      'blur':{args:{radius:20.0}},
      'blur2':{args:{radius:20.0,exponent: 1.0}},
      'zoomBlur':{args:{center:{type:'pos',x:0,y:0}, size: 0.1}},
      'denoise':{args:{strength:10.0}},
      'denoisefast':{args:{strength:30.0}},
      'erode':{args:{iterations:2.0}},
      'dilate':{args:{iterations:2.0}},
      'sobel':{args:{secondary:0.5,coeff:0.5,alpha:0.5,areas:{type:'rgba',r:0,g:0,b:0,a:1},edges:{type:'rgba',r:1,g:1,b:1,a:1}}},
      'unsharpMask':{args:{size:3.0,strength:{type:'osc',f:5.0,a:2.0,p:0.0,o:2.0}}},
      'localContrast':{args:{size:10.0,strength:0.5}},
      'pixelate':{args:{x1:10.0,y1:10.0, x2:10.0,y2:10.0 }},
      'hexagonalPixelate':{args:{center:{type:'pos',x:0,y:0}, size: 10.0}},
      'ripple':{args:{width:0.3,length:0.3,angle:0.0,strength:2.0}},
      'bulgePinch':{args:{center:{type:'pos',x:0,y:0},radius:600,strength:0.2}},
      'swirl':{args:{center:{type:'pos',x:0,y:0},radius:250.0,strength:{type:'osc',f:5.0,a:1.0,p:0.0,o:0.0}}},
      'colorDisplacement':{args:{angle:0.0,strength:3.0}},
      'grid':{args:{size:1.0,angle:0.0}},
      'gauze':{args:{width:300,length:200,angle:0.0,strength:0.5,center:{type:'pos',x:0.0,y:0.0}}},
      'life':{},
      'colorHalftone':{args:{center:{type:'pos',x:0,y:0},angle:30.0,size:{type:'osc',f:5.0,a:1.0,p:0.0,o:2.0}}},
      'analogize':{args:{exposure:2.0,gamma:1.5,glow:1.0,glow_radius:16.0}},
      'relief':{args:{scale2:16.0,scale4:64.0}},
      'mandelbrot':{args:{center:{type:'pos',x:0.7,y:0.5},size:3.0,angle:0.0,iterations:10.0}},
      'julia':{args:{cx:-0.8, cy:0.2, center:{type:'pos',x:0.7,y:0.5},size:3.0,angle:0.0,iterations:10.0}},
      'smoothlife':{args:{birth_min:7.0,birth_max:10.0,death_min:15.0}},
      'soft_life':{args:{birth_min:7.0,birth_max:10.0,death_min:15.0}},      
      'reaction':{args:{noise_factor:0.5,zoom_speed:0.005,scale1:8.0,scale2:16.0,scale3:32.0,scale4:64.0}},
      'reaction2':{args:{F:0.0545,K:0.062,D_a:0.2,D_b:0.1,iterations:1.0}},
      'glitch':{args:{scale:16.0,detail: 25.0, strength: 0.9,speed: 1.0}},
      'supershape':{args:{angleX:-0.7,angleY:{type:'osc',f:0.1,a:10.0,p:0.0,o:0.0},a1:1.0,b1:1.0,m1:5.0,n11:1.0,n21:1.0,n31:2.0,a2:1.0,b2:1.0,m2:5.0,n12:1.0,n22:1.0,n32:3.0}},
      'address_glitch':{args:{mask_x:8.0,mask_y:0.0}},
    };
    
    var new_effects=[];
    var effect_ids={};
    for(key in effects)
    {
      // create flat object with the effect name in 'effect'
      // like the ones send to the server
      var new_effect={effect:key};
      if(effects[key].args)
        for(var i in effects[key].args)
          new_effect[i]=effects[key].args[i];
      effect_ids[key]=new_effects.length;
      new_effects.push(new_effect);
    }
    effects=new_effects;
        
    // load chains
    get('/saves'+session_url+'chains.json',function(data){
      if(!data) // no saved chains in this session 
        get('/saves/chains.json',load); // load default chain instead
      else
        load(data);
    });


    // add knobs
    var add_knob=function(selector,callback)
    {
      var down=false,dragged=false,last_angle=0;
      
      var polar=function(e)
      {
        var x=e.offsetX, y=e.offsetY;
        var dx=x-e.target.offsetWidth/2,dy=y-e.target.offsetWidth/2;
        e.a=Math.atan2(dx,dy);
        e.r=Math.sqrt(dx*dx+dy*dy);
      }
      var move_handler=function(e)
      {
        polar(e);
        if(down)
        {
          var da=e.a-last_angle;
          if(da> Math.PI) da-=Math.PI;
          if(da<-Math.PI) da+=Math.PI;
          da=da/Math.PI*16.0; //32 steps / circle
          da=Math.round(da);
          if(da!=0)
          {
            callback(selector,'change',-Math.sign(da));
            dragged=true;
            last_angle=e.a;
          }
        }else
          last_angle=e.a; // snap back
      }
      var down_handler=function(e)
      {
        down   =true;
        dragged=false;
      }
      var up_handler=function(e)
      {
        if(!dragged) callback(selector,'press');
        down=false;
      }
      
      $(selector).on('mousemove',move_handler);
      $(selector).on('mousedown',down_handler);
      $(selector).on('mouseup',up_handler);
    };

    var pad=function(text,n)
    {
      text=''+text;
      var d=n-text.length;
      if(d>0) text+=' '.repeat(d);
      return text.substring(0,n);
    }
    var pad_left=function(text,n)
    {
      text=''+text;
      var d=n-text.length;
      if(d>0) text=' '.repeat(d)+text;
      return text.substring(0,n);
    }


    var chain_id=0,layer_id=1,param_id=1, flat=[];


    var flatten=function()
    {
      var stack=[], flat=[];
      stack.push({'o':chain,'i':layer_id});
      
      while(stack.length)
      {
        var path=stack.pop();
        var obj=path.o[path.i];
        if(obj instanceof Object)
        {
          for(key in obj)
            if(key!='type')// hide 'type' slots
              stack.push({'o':obj,'i':key});
        }
        else
          flat.unshift(path);
      }
      
      return flat;
    }

    var get_param=function(i)
    {
      var path=flat[i];
      return path.i;
    }
    
    var get_value=function(i)
    {
      var path=flat[i];
      return path.o[path.i];
    }

    var set_value=function(i,value)
    {
      var path=flat[i];
      path.o[path.i]=value;
    }    

    var clamp=function(x,left,right)
    {
      if(x<left  ) x=left;
      if(x>=right) x=right-1;
      return x;
    }

    var main_ui=function(id,type,delta)
    {
      if(type=='change' && id=='#knob_patch' && delta!=0)
      {
        chain_id+=delta;
        layer_id=1;
        param_id=0;
      }
      
      if(type == 'press' && id=='#knob_patch')
      {
        // allow edit of names
        ui_fn=name_ui;
        ui_fn();
        return;
      }

      if(type=='change' && id=='#knob_layer' && delta!=0)
      {
        layer_id+=delta;
        param_id=1;      
      }
      if(type=='change' && id=='#knob_param' && delta!=0)
      {
        param_id+=delta;
      }
            
      chain_id=clamp(chain_id,0,chains.length);
      chain=chains[chain_id];
      layer_id=clamp(layer_id,1,chain.length);
      layer=chain[layer_id];

      //  update flat view on parameters
      flat=flatten();
      
      param_id=clamp(param_id,0,flat.length);

      var effect=layer['effect'];
      var param =get_param(param_id);      
      var value =get_value(param_id);

      if(type=='change' && id=='#knob_value' && delta!=0)
      {
        // TODO handle special case for param 'effect', which replaces the current effect by one of the effects list
        
        if(param=='effect')
        {
          var i=effect_ids[value];
          i+=delta;
          if(!i || i>=new_effects.length) i=0;
          chain[layer_id]=layer=JSON.parse(JSON.stringify(new_effects[i]));
        }
        else
        {        
          var path =flat[param_id];
          path.o[path.i]+=delta/100.0;
        }
      }

      var text=
        ' PATCH '+pad_left(chain_id,2)+'| LAYER '+pad_left(layer_id,2)+'| PARAM '+pad_left(param_id,2)+'| VALUE\n'+
        pad(chain[0],9)+'|'+pad(effect,9)+'|'+pad(param,9)+'|'+pad_left(value,10);
      $('.display').html(text);
      
      updateChain();
    }
    
    var cursor=0;
    var name_ui=function(id,type,delta)
    {
      var name=chain[0];

      if(type=='change' && id=='#knob_param' && delta!=0)
      { 
        cursor+=delta;
        if(cursor<0)            cursor=0;
        if(cursor>=name.length) cursor=name.length-1;
      }

      if(type=='change' && id=='#knob_value' && delta!=0)
      {
        var letter=name.charCodeAt(cursor);
        if(!letter) letter='a';
        letter=String.fromCharCode(letter+delta);
        if(letter<12 || letter>255) letter='';
        name=name.substring(0,cursor)+letter+name.substring(cursor+1);
        chain[0]=name;
      }
     if(type=='press')
     {
        ui_fn=main_ui;
        ui_fn();
        return;
      }
      
      var text='EDIT NAME: '+name+'\n'
              +'           '+pad_left('^',cursor+1)+pad_left('',10-cursor)+'  &lt; &gt;      LETTER';
      $('.display').html(text);
    }
    
    var ui_fn=main_ui;
    var knob_handler=function(id,type,value){
      var last_ui_fn=ui_fn;
      ui_fn(id,type,value);
    };
        
    add_knob('#knob_patch',knob_handler);
    add_knob('#knob_layer',knob_handler);
    add_knob('#knob_param',knob_handler);
    add_knob('#knob_value',knob_handler);
    
    </script>

</body>
</html>

