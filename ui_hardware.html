<!DOCTYPE  html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>NF VisSynth MCP</title>
  <script src="jquery-2.1.4.js"></script>
  <script src="effects.js"></script>
</head>
<body style="font-size: 20px;">


  <style>
  
   /* general element styles */

   body,html{   
      font-family: sans-serif;    
      margin: 0px;
      padding: 0px;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none; 
  }
  
  
.ui{
  display: inline-block;
  background-color: #444;
  color: #fff;
  padding: 12px;
}
.channel{
  display: inline-block;
  text-align: center;
}
.knob{
  width: 100px;
  height: 100px;
  border-radius: 50px;
  border: 5px dashed #888;
  color: #fff;
  background-color: #000;
  margin: 10px;
  text-align:center;
  font-size: 15px;
}
.display
{
  font-family: monospace;
  font-size: 22px;
  font-weight: bold;
  background-color: #ddd;
  margin: 5px;
  padding: 5px;
  color: #000;
}

  </style>




<div class=ui style='width:auto;'>
  <div>NF VisSynthBox Mark I</div>
  <pre class=display></pre>
  <div class=channel>
    <div class=knob id=knob_patch></div>
  </div>
  <div class=channel>
    <div class=knob id=knob_layer></div>
  </div>
  <div class=channel>
    <div class=knob id=knob_param></div>
  </div>
  <div class=channel>
    <div class=knob id=knob_value></div>
  </div>
</div>


  <span id=stats></span>
  

  <script>
  
    // get session url, if any
    var session_url='/';
    if(document.location.hash)
      session_url+=document.location.hash.substring(1)+'_';

    var put=function(url,data)
    {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.responseType='text';
      xmlHttp.open('PUT',url,true);
      xmlHttp.send(data);
    }
    
    var get=function(url,callback)
    {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.responseType='text';
      xmlHttp.open('GET',url,true);
      xmlHttp.onreadystatechange=function()
      {
        if(xmlHttp.readyState!=4) return;
        callback(xmlHttp.responseText);      
      }
      xmlHttp.send(null);      
    }
    
    // send command to remote server
    function send(command)
    {
      put('/feeds'+session_url+'command',command+';\n');
    }

    function restart()
    {
      send('document.location.reload()');
      setTimeout(updateChain,500); // TODO get rid of wait (race condition prone)
    }

    /* save all chains to server  */
    var save=function()
    {
      var json=JSON.stringify(chains,null,' ');
      put('/saves'+session_url+'chains.json',json);
      
      console.log('Saved.');
      
      savetimeout=false;
    }
          
    var clone=function(o)
    {
      return JSON.parse(JSON.stringify(o));
    }

    var savetimeout=false;
    var updateChain=function(event,ui)
    {
      if(savetimeout) clearTimeout(savetimeout);
      savetimeout=setTimeout(save,1000);
            
      var full_chain=pre_chain.concat(chain,post_chain);                              

      // send out to control server
      send('setChain('+JSON.stringify(full_chain)+')');
    }

        
    var load=function(json)
    {
      if(!json) return;
      chains=JSON.parse(json);

      // add pre- and post chain to legacy chains 
      if(typeof(chains[0][0])=='string') // if first chain is a named one, we have a legacy save.
        chains.unshift([{"effect": "capture","device": 0}],[]);

      pre_chain=chains.shift();
      post_chain=chains.shift();      
      
      main_ui();
    }


    
    var new_effects=[];
    var effect_ids={};
    for(key in effects) // effects from effects.js
    {
      // create flat object with the effect name in 'effect'
      // like the ones send to the server
      var new_effect={effect:key};
      if(effects[key].args)
        for(var i in effects[key].args)
          new_effect[i]=effects[key].args[i];
      effect_ids[key]=new_effects.length;
      new_effects.push(new_effect);
    }
    effects=new_effects;
        
    // load chains
    get('/saves'+session_url+'chains.json',function(data){
      if(!data) // no saved chains in this session 
        get('/saves/chains.json',load); // load default chain instead
      else
        load(data);
    });


    // add knobs
    var add_knob=function(selector,callback)
    {
      var down=false,dragged=false,last_angle=0;
      
      var polar=function(e)
      {
        var x=e.offsetX, y=e.offsetY;
        var dx=x-e.target.offsetWidth/2,dy=y-e.target.offsetWidth/2;
        e.a=Math.atan2(dx,dy);
        e.r=Math.sqrt(dx*dx+dy*dy);
      }
      var move_handler=function(e)
      {
        polar(e);
        if(down)
        {
          var da=e.a-last_angle;
          if(da> Math.PI) da-=Math.PI;
          if(da<-Math.PI) da+=Math.PI;
          da=da/Math.PI*8.0; //16 steps / circle
          da=Math.round(da);
          if(da!=0)
          {
            callback(selector,'change',-Math.sign(da));
            dragged=true;
            last_angle=e.a;
          }
        }else
          last_angle=e.a; // snap back
      }
      var down_handler=function(e)
      {
        down   =true;
        dragged=false;
      }
      var up_handler=function(e)
      {
        if(!dragged) callback(selector,'press');
        down=false;
      }
      
      $(selector).on('mousemove',move_handler);
      $(selector).on('mousedown',down_handler);
      $(selector).on('mouseup',up_handler);
    };

    var pad=function(text,n)
    {
      text=''+text;
      var d=n-text.length;
      if(d>0) text+=' '.repeat(d);
      return text.substring(0,n);
    }
    var pad_left=function(text,n)
    {
      text=''+text;
      var d=n-text.length;
      if(d>0) text=' '.repeat(d)+text;
      return text.substring(0,n);
    }


    var chain_id=0,layer_id=1,param_id=1, flat=[];


    var flatten=function()
    {
      var stack=[], flat=[];
      stack.push({'o':chain,'i':layer_id});
      
      while(stack.length)
      {
        var path=stack.shift();
        var obj=path.o[path.i];
        flat.push(path);
        if(obj instanceof Object)
        {
          for(key in obj)
            if(key!='type')// hide 'type' slots
              stack.push({'o':obj,'i':key});
        }
//        else
      }
      
      // remove root element
      flat.shift();
      
      return flat;
    }

    var get_param=function(i)
    {
      var path=flat[i];
      return path.i;
    }
    
    var get_value=function(i)
    {
      var path=flat[i];
      return path.o[path.i];
    }

    var set_value=function(i,value)
    {
      var path=flat[i];
      path.o[path.i]=value;
    }    

    var clamp=function(x,left,right)
    {
      if(x>=right) x=right-1;
      if(x<left  ) x=left;
      return x;
    }

    var main_ui=function(id,type,delta)
    {
      if(type=='change' && id=='#knob_patch' && delta!=0)
      {
        chain_id+=delta;
        layer_id=1;
        param_id=0;
      }
      
      if(type == 'press' && id!='#knob_value')
      {
        if(id=='#knob_patch') ui_fn=chain_ui;
        if(id=='#knob_layer') ui_fn=layer_ui;
        ui_fn();
        return;
      }

      if(type=='change' && id=='#knob_layer' && delta!=0)
      {
        layer_id+=delta;
        param_id=1;      
      }
      if(type=='change' && id=='#knob_param' && delta!=0)
      {
        param_id+=delta;
      }
            
      chain_id=clamp(chain_id,0,chains.length);
      chain=chains[chain_id];
      layer_id=clamp(layer_id,1,chain.length);
      
      // create empty layer, if none is present
      if(!chain[layer_id]) chain[layer_id]={effect:''};

      //  update flat view on parameters
      flat=flatten();
      
      param_id=clamp(param_id,0,flat.length);
      var path =flat[param_id];
      
      // values may be toggled toggled to OSC and BEAT 
      if(type=='press' && id=='#knob_value' && path.o['type']!='osc' && path.o['type']!='beat')
      {
        var value=path.o[path.i];
        if(typeof(value)=='number')
        {
          // convert number to OSC
          value={type:'osc',f:5.0,a:value/2,p:0.0,o:value,waveform:'sine',duty:0.5};          
        }
        else if(typeof(value)=='object' && value['type']=='osc')
        {
          // convert OSC to BEAT
          value={type:'beat',pulse:10.0,f:2.0,a:value.a,p:0.0,o:value.o};
        }
        else if(typeof(value)=='object' && value['type']=='beat')        
        {
          //convert BEAT to number
          value=Math.abs(value.a)>Math.abs(value.o) ? value.a : value.o;          
        }
        path.o[path.i]=value;
        flat=flatten();
        path=flat[param_id];
      }

      var param =get_param(param_id);

      if(type=='change' && id=='#knob_value' && delta!=0)
      {
        // TODO handle special case for param 'effect', which replaces the current effect by one of the effects list
                
        if(!chain[layer_id] || param=='effect')
        {
          var i=effect_ids[path.o[path.i]];
          i+=delta;
          if(!i || i>=new_effects.length) i=0;
          chain[layer_id]=clone(new_effects[i]);
          flat=flatten();
          path=flat[param_id];
        }
        else if(path.o[path.i] instanceof Object)
        {
          // TODO replace object types, eg. OSC, BEAT
        }
        else
        {        
          var path =flat[param_id];
          var s=Math.abs(path.o[path.i]/64.0);
          s=Math.max(s,0.001);
          path.o[path.i]+=s*delta;
          path.o[path.i]=Math.round(path.o[path.i]*1000.0)/1000.0;
        }
      }

      var value_shown=path.o[path.i];
      if(value_shown instanceof Object) value_shown=value_shown['type'].toUpperCase();

      var text=
        'PATCH '+pad_left(chain_id,3)+'|LAYER '+pad_left(layer_id,3)+'|PARAM '+pad_left(param_id,3)+'| VALUE\n'+
        pad(chain[0],9)+'|'+pad(chain[layer_id]['effect'],9)+'|'+pad(param,9)+'|'+pad_left(value_shown,10);
      $('.display').html(text);
      
      updateChain();
    }
    
    var cursor=0;
    var chain_ui=function(id,type,delta)
    {
      var name=chain[0];

      if(type=='change' && id=='#knob_param' && delta!=0)
      { 
        cursor+=delta;
        if(cursor<0)            cursor=0;
        if(cursor>=name.length) cursor=name.length-1;
      }

      if(type=='change' && id=='#knob_value' && delta!=0)
      {
        var letter=name[cursor];
        if(!letter) letter='a';
        var letters=' _abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        var ord=letters.indexOf(letter);
        var new_letter=letters[ord+delta];
        if(!new_letter) new_letter=' ';
        name=name.substring(0,cursor)+new_letter+name.substring(cursor+1);
        chain[0]=name;
      }
      if(type=='press')
      {
        if(id=='#knob_patch') chains.unshift(clone(chain));
        if(id=='#knob_layer') chains.splice(chain_id,1);
        ui_fn=main_ui;
        ui_fn();
        return;
      }

      var text='PATCH '+pad_left(chain_id,3)+'          |'+pad(name,9)+'\n'
              +'CLONE    |DELETE   |'+pad_left('^',cursor+1)+pad_left('',9-cursor)+'|RENAME   ';
      $('.display').html(text);
    }

    var clipboard=null;
    var layer_ui=function(id,type,delta)
    {
      var name=chain[0];

      if(type=='press')
      {
        if(id=='#knob_patch') chain.splice(layer_id,0,{'effect':''});
        if(id=='#knob_layer') clipboard=chain[layer_id];
        if(id=='#knob_param') clipboard=chain.splice(layer_id,1)[0];
        if(id=='#knob_value') chain.splice(layer_id,0,clone(clipboard));
        ui_fn=main_ui;
        ui_fn();
        return;
      }

      var text='           LAYER '+pad_left(layer_id,2)+' : '+chain[layer_id]['effect']+'\n'
              +'NEW      |COPY     |CUT      |PASTE   ';
      $('.display').html(text);
    }

    
    var ui_fn=main_ui;
    var knob_handler=function(id,type,value){
      var last_ui_fn=ui_fn;
      ui_fn(id,type,value);
    };
        
    add_knob('#knob_patch',knob_handler);
    add_knob('#knob_layer',knob_handler);
    add_knob('#knob_param',knob_handler);
    add_knob('#knob_value',knob_handler);
    
    </script>

</body>
</html>

