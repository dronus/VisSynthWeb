<!DOCTYPE  html>
<html>
<head>
  <title>NF VisSynth MCP</title>
  <script src="jquery-2.1.4.js"></script>
  <script src="jquery-ui.js"></script>
</head>
<body style="font-size: 20px;">
  <h1 style="font-size:100%">NF VIS SYNTH MASTER CONTROL PROGRAM</h1>
  <div id=result style="margin: auto; width: 50em;"></div><br>
  <input type=text id=command style="margin: auto; width: 50em;"></input><br>
  <button onclick="send('document.location.reload()')">RESTART</button>


  <ul id=effects></ul>
  <ul id=chain></ul>
  
  <br>
  <button onclick="start_preview()">PLAY PREVIEW</button>
  <button onclick="stop_preview()">PAUSE PREVIEW</button>
  <br>
  <img id=preview></img>

  <style>
   #effects, #chain{
      vertical-align: top;
      display: inline-block;
      width: 500px;
      height: 50vh;
      border: 1px solid black;
      padding: 2px;
      overflow: auto;
    }
    .effect{
      background-color: #ddd;
      margin: 2px;
      padding: 2px;
      border: 1px solid #000;
      list-style: none;
      width: 480px;
    }
    .value{
      color: blue;
    }
    input.value_ui{
      position: absolute;
      width: 500px;
      background-color: #555;
    }
  </style>

  <script>

    var updateChain=function(event,ui)
    {
      var chain='[ ';
      $('#chain *').each(function(){
        var src=$(this).text();
        chain+=src+',';
      });
      chain+=' ]';
      send('setChain("'+chain+'")');
    }
    
    var logify=function(x){
      return(Math.log(Math.abs(x)+1)/Math.LN2*(x>0 ? 1 : -1));
    }
    
    var expify=function(x){
      return Math.round((x>0 ? 1 : -1)*(Math.pow(2.,Math.abs(x))-1)*100.)/100.;
    }
    
    
    var add_slider=function(event)
    {
      var value_element=this;
      var slider=$('<input class=value_ui type=range min="-10" max="10" step="0.01">');
      slider.attr('value',logify($(this).html()));
      slider.on('mouseup',function(){slider.remove()});
      slider.on('input',function(event){
        $(value_element).html(expify(this.value));
        updateChain();
      });
      $(document.body).append(slider);
      slider.position({my:'top',at:'bottom',of:$(this)});
    }
    
    var markup=function(item){
      var html=item.html();
      var regex=/([0-9]+.[0-9]+)/g;
      item.html(html.replace(regex,'<span class=value>$1</span>'));
      item.find('span').on('click',add_slider);
    }

    $("ul, li").disableSelection();

    // build list of effects  
    var effects=[    
      "vibrance(1.0)",
      "hueSaturation(0.0,0.3)",
      "feedbackOut(0.7)",
      "feedbackIn()",
      "kaleidoscope(Math.sin(t*5.0),Math.cos(t*2.0))",
      "tile()",
      "colorHalftone(w/2,h/2,30.0,2.0+Math.sin(t*5.0))",
      "unsharpMask(3.0,(Math.sin(t*5.0)+1.0)*2.0)",
      "denoise(3.0)",
      "swirl(w/2, h/2, 250.0, Math.sin(t*5.0)*1.0)",
      "hexagonalPixelate(w/2,h/2,4.0+(Math.sin(t*5.0)+1.0)*2.0)",
      "grid()"
    ];
    effects.forEach(function(effect){
      $('#effects').append('<li class=effect>'+effect+'</li>');
    });

    // the effects may be dragged to the chain list
    $('#effects *').draggable({
      connectToSortable: "#chain",
      helper: "clone",
      revert: "invalid",
      stop: updateChain
    });

    // the chain list items are sortable
    $( "#chain" ).sortable({
      //revert: true,
      stop: updateChain,
      receive: function(event,ui){
        markup($(this).data()['ui-sortable'].currentItem);
        updateChain(event,ui);
      }
    }).droppable({greedy: true});

    // delete items that are dragged out of the chain
    $('body').droppable({
      drop: function ( event, ui ) {          
        ui.draggable.remove();
      },
      accept: '#chain *'
    });

  
    var put=function(url)
    {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open('PUT',url,true);
      xmlHttp.send(null);      
    }
    
    var get=function(url,callback)
    {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open('GET',url,true);
      xmlHttp.onreadystatechange=function()
      {
        if(xmlHttp.readyState!=4) return;
        callback(xmlHttp.responseText);      
      }
      xmlHttp.send(null);      
    }
    
    function result(text)
    {
      document.getElementById('result').innerHTML=text;
    }
    
    function send(command,callback)
    {
      command+=';\n';
      console.log(command);
      
      // setup listener for possible incoming result
      if(callback)
        get('/result',callback);
      
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open('PUT','/command',true);  
      xmlHttp.send(command);
    }

    var cmd_element=document.getElementById('command');
    cmd_element.addEventListener('change',function(){
      send(cmd_element.value,result);      
      cmd_element.value='';
    });

    var preview=false;

    var preview_handler=function(){
    
      if(!preview) return;         

      get('/preview',function(data)
      {
        if(data)
          document.getElementById('preview').src=data;
        requestAnimationFrame(preview_handler);          
      });

      send('preview()');
    };
        
    function start_preview(){
      preview=true;
      requestAnimationFrame(preview_handler);
    }
    
    function stop_preview(){
      preview=false;
      document.getElementById('preview').src='';
    }
   
   /*
    TODO
    perspective adjustment UI from index.html:
      var pc=get_cookie('perspective');

    var perspective=pc ? JSON.parse(pc) : [0,0,0,h,w,0,w,h];

    var dragged=false;
    c.canvas.addEventListener('mousedown',function(e){
      if(e.button==1)
        perspective=[0,0,0,h,w,0,w,h];
      else    
        dragged=true;
    });
    c.canvas.addEventListener('mouseup'  ,function(e){dragged=false;});
    c.canvas.addEventListener('mousemove',function(e){
      if(!dragged) return;
      var x=e.offsetX/c.canvas.offsetWidth*w, y=e.offsetY/c.canvas.offsetHeight*h;
      var i=0;
      if(x>w/2) i+=2;
      if(y>h/2) i+=1;
      perspective[i*2]=x;
      perspective[i*2+1]=y;  
      set_cookie('perspective',JSON.stringify(perspective));    
    });
    
    
   */
  </script>

</body>
</html>
