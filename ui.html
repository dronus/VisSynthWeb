<!DOCTYPE  html>
<html>
<head>
  <title>NF VisSynth MCP</title>
</head>
<body style="font-size: 30px;">
  <h1 style="font-size:100%">NF VIS SYNTH MASTER CONTROL PROGRAM</h1>
  <div id=result style="margin: auto; width: 50em;"></div><br>
  <input type=text id=command style="margin: auto; width: 50em;"></input><br>
  <button onclick="send('document.location.reload()')">RESTART</button>
  |
  <button onclick="send('prev()')">PREV</button>
  <button onclick="send('next()')">NEXT</button>
  |
  <button onclick="send('start('+parseFloat(document.getElementById('delay').value)*1000+')')">START</button>
  <input type=text id=delay style="width: 5em;" value=10>
  <button onclick="send('stop()')">STOP</button>
  
  <br>
  <button onclick="start_preview()">PLAY PREVIEW</button>
  <button onclick="stop_preview()">PAUSE PREVIEW</button>
  <br>
  <img id=preview></img>

  <script>    
  
    var put=function(url)
    {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open('PUT',url,true);
      xmlHttp.send(null);      
    }
    
    var get=function(url,callback)
    {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open('GET',url,true);
      xmlHttp.onreadystatechange=function()
      {
        if(xmlHttp.readyState!=4) return;
        callback(xmlHttp.responseText);      
      }
      xmlHttp.send(null);      
    }
    
    function result(text)
    {
      document.getElementById('result').innerHTML=text;
    }
    
    function send(command,callback)
    {
      command+=';\n';
      console.log(command);
      
      // setup listener for possible incoming result
      if(callback)
        get('/result',callback);
      
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open('PUT','/command',true);  
      xmlHttp.send(command);
    }

    var cmd_element=document.getElementById('command');
    cmd_element.addEventListener('change',function(){
      send(cmd_element.value,result);      
      cmd_element.value='';
    });

    var preview=false;

    var preview_handler=function(){
    
      if(!preview) return;         

      get('/preview',function(data)
      {
        if(data)
          document.getElementById('preview').src=data;
        requestAnimationFrame(preview_handler);          
      });

      send('preview()');
    };
        
    function start_preview(){
      preview=true;
      requestAnimationFrame(preview_handler);
    }
    
    function stop_preview(){
      preview=false;
      document.getElementById('preview').src='';
    }
   
   /*
    TODO
    perspective adjustment UI from index.html:
      var pc=get_cookie('perspective');

    var perspective=pc ? JSON.parse(pc) : [0,0,0,h,w,0,w,h];

    var dragged=false;
    c.canvas.addEventListener('mousedown',function(e){
      if(e.button==1)
        perspective=[0,0,0,h,w,0,w,h];
      else    
        dragged=true;
    });
    c.canvas.addEventListener('mouseup'  ,function(e){dragged=false;});
    c.canvas.addEventListener('mousemove',function(e){
      if(!dragged) return;
      var x=e.offsetX/c.canvas.offsetWidth*w, y=e.offsetY/c.canvas.offsetHeight*h;
      var i=0;
      if(x>w/2) i+=2;
      if(y>h/2) i+=1;
      perspective[i*2]=x;
      perspective[i*2+1]=y;  
      set_cookie('perspective',JSON.stringify(perspective));    
    });
    
    
   */
  </script>

</body>
</html>
