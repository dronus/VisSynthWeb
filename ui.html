<!DOCTYPE  html>
<html>
<head>
  <title>NF VisSynth MCP</title>
  <script src="jquery-2.1.4.js"></script>
  <script src="jquery-ui.js"></script>
</head>
<body style="font-size: 20px;">

  <div class="header container">
    <h1 style="font-size:100%">NF VIS SYNTH MASTER CONTROL PROGRAM</h1>
    <button onclick="send('document.location.reload()')">RESTART</button>
  </div>


  <div class="effects container">
    <h2>Effects</h2>
    <ul id=effects></ul>
  </div>
  <div id="chains">
    <div class="container">
      <h2>Chain 1</h2>
      <ul class="chain"></ul>
    </div>
  </div>
  
  <div class="preview container">
    <button onclick="start_preview()">PLAY PREVIEW</button>
    <button onclick="stop_preview()">PAUSE PREVIEW</button>
    <br>
    <img id=preview></img>
  </div>

  <input type=text id=command style="margin: auto; width: 50em;"></input>  
  <div id=result style="margin: auto; width: 50em;"></div><br>


  <style>
   body,html{   
      background-color: #000;
      color: #aaa;
      font-family: sans-serif;    
      height: 100%;
      margin: 0px;
      padding: 0px;
      width: 100%;
   }
   h1{
    display: inline;
   }
   h2{
    display: block;
    color: #fff;
    margin: 2px;
    padding: 5px;
    font-size: 110%;
   }
   button{
      border-radius: 5px;
      background-color: #733;
      color: #fff;
      padding: 8px;
   }

   .container{
    border: 1px solid #999;
    padding: 5px;
    margin: 2px;
    border-radius: 5px;
    background-color: #000;
   }
   
   .header{
     position: fixed;
     top: 0px;
     left: 0px;
     right: 0px;
     height: 40px;
   }

   .preview{
      position: fixed;
      bottom: 0px;
      left: 570px;
      width: 320px;
      height: 320px;
   }
   .preview img{
    width: 100%;
   }
      
   .effects, #chains{   
      position: fixed;
      top: 55px;
      bottom: 0px;
    }
    #chains{
      bottom: 350px;
    }
    .effects{
      width: 550px;
      overflow-y: auto;
      overflow-x: hidden;
    }
    #chains{    
      left: 570px;
      right: 0px;
      overflow-x: auto;
      overflow-y: hidden;
      white-space: nowrap;      
    }

    #chains>*{
      display:inline-block;
      vertical-align: top;
      white-space: normal;
      overflow-y: auto;
      overflow-x: hidden;
    }
    
    #chains .active{
      background-color: #030;
      border-color: #0f0;
    }
    
    #chains .active .effect{
      background-color: #050;
      border-color: #0f0;
    }
    
    #effects, .chain{
      margin: 0px;
      padding: 0px;
      width: 270px;
      height: 80%;
    }
    .chain:empty{
      width: 50px;
    }
    
    #effects{
      width: 540px;
    }
    #chains .container{
      height: 95%;
    }
    .effect{
      display: inline-block;
      list-style: none;    
      background-color: #333;
      color: #fff;
      margin: 2px;
      padding: 5px;
      border: 1px solid #000;
      border-radius: 5px;
      width: 250px;
    }
    .effect div{
      display: block;
      font-size: 12px;
    }
    .value{
      color: #f94;
    }
    input.value_ui{
      position: fixed;
      background-color: #555;
      border-radius: 10px;      
      width: 500px;
    }
  </style>

  <script>
  
    var put=function(url,data)
    {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open('PUT',url,true);
      xmlHttp.send(data);
    }
    
    var get=function(url,callback)
    {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open('GET',url,true);
      xmlHttp.onreadystatechange=function()
      {
        if(xmlHttp.readyState!=4) return;
        callback(xmlHttp.responseText);      
      }
      xmlHttp.send(null);      
    }
    
    var save=function()
    {
      var chains=[];      
      $('#chains .chain').each(function(){
        var chain=[];
        $(this).find('>*').each(function(){
          var src=$(this).text();
          chain.push(src);
        });
        if(chain.length) chains.push(chain);
      });
                  
      var json=JSON.stringify(chains);
      put('chains.json',json);
      
      console.log('Saved.');
      
      savetimeout=false;
    }
            
    var listEffects=function(effects,container)
    {
      effects.forEach(function(effect){
        $(container).append('<li class=effect>'+effect.replace('(','<div>(')+'</div></li>');
      });
    }
   
    var add_slider=function(event)
    {
      var value_element=this;
      var slider=$('<input class=value_ui type=range min="-10" max="10" step="0.01">');
      slider.attr('value',logify($(this).html()));
      slider.on('mouseup',function(){slider.remove()});
      slider.on('input',function(event){
        $(value_element).html(expify(this.value));
        updateChain();
      });
      $(document.body).append(slider);
      slider.position({my:'top',at:'bottom',of:$(this)});
    }

    var markup=function(item){
      var html=item.html();
      var regex=/([0-9]+.[0-9]+)/g;
      item.html(html.replace(regex,'<span class=value>$1</span>'));
      item.find('span').on('click',add_slider);
    }
        
    savetimeout=false;
    var updateChain=function(event,ui)
    {
      
      if(savetimeout) clearTimeout(savetimeout);
      savetimeout=setTimeout(save,1000);
      
      var chain='[ ';
      $('#chains .active .effect').each(function(){
        var src=$(this).text();
        chain+=src+',';
      });
      chain+=' ]';
      send('setChain("'+chain+'")');
      
      // add empty list, if all are used
      ensure_empty_list();      
    }

    var init_chain_list=function(container)
    {
      // the chain list items are sortable
      $(container).sortable({
        //revert: true,
        stop: updateChain,
        receive: function(event,ui){
          markup($(this).data()['ui-sortable'].currentItem);
          updateChain(event,ui);
        }
      }).droppable({greedy: true});      
    }
    init_chain_list('.chain');
        
    var empty_list=$('#chains .container').clone();
    
    $('#chains .container').addClass('active');
    
    var ensure_empty_list=function(){
      // delete surplus empty lists
      $('#chains .container').has('.chain:empty').remove();
      
      // add another empty list
      $('#chains').append(empty_list.clone());
      init_chain_list('#chains .container:last-child .chain');
      
      // ensure names
      $('#chains .container h2').each(function(i){
        $(this).html('Chain '+(i+1));
      });        
    }
    
    var load=function(json)
    {
      if(!json) return;
      var chains=JSON.parse(json);
      
      chains.forEach(function(chain){
        var list=$('#chains .container:last-child .chain');
        listEffects(chain,list);
        list.find('.effect').each(function(){
          markup($(this));
        });
        
        // append another empty list
        ensure_empty_list();
      });
    }    
    get('chains.json',load);
    
    var logify=function(x){
      return(Math.log(Math.abs(x)+1)/Math.LN2*(x>0 ? 1 : -1));
    }
    
    var expify=function(x){
      return Math.round((x>0 ? 1 : -1)*(Math.pow(2.,Math.abs(x))-1)*100.)/100.;
    }
       
    $("ul, li").disableSelection();

    // build list of effects  
    var effects=[    
      "vibrance(1.0)",
      "brightnessContrast(0.0, 0.0)",
      "hueSaturation(0.0,0.3)",
      "feedbackOut(0.7)",
      "feedbackIn()",
      "kaleidoscope(5.0,Math.sin(t*5.0),Math.cos(t*2.0))",
      "tile(2.0)",
      "colorHalftone(w/2,h/2,30.0,2.0+Math.sin(t*5.0))",
      "unsharpMask(3.0,(Math.sin(t*5.0)+1.0)*2.0)",
      "denoise(3.0)",
      "denoisefast(3.0)",
      "triangleBlur(10.0)",
      "zoomBlur(w/2, h/2, 0.03)",
      "bulgePinch(w/2, h/2, 600, 0.2)",
      "swirl(w/2, h/2, 250.0, Math.sin(t*5.0)*1.0)",
      "hexagonalPixelate(w/2,h/2,4.0+(Math.sin(t*5.0)+1.0)*2.0)",
      "grid(1.0,0.0)",
      "life()",
      "ripple(0.3,0.3,0.0,2.0)",
      "colorDisplacement(0.0,3.0)",
      "analogize(2.0,1.5,1.0,16.0)"
    ];
    listEffects(effects,'#effects');
        
    // the effects may be dragged to the chain list
    $('#effects>*').draggable({
/*      appendTo:'body',*/
      connectToSortable: ".chain",
      appendTo:'body',
      helper: "clone",
      revert: "invalid",
      stop: updateChain
    });

    // the chains are sortable...
    $("#chains").sortable({
//      stop: updateChains    
    });
    
    $('#chains').on('click','.container',function(){
      $('#chains .container').removeClass('active');
      $(this).addClass('active');
      updateChain();
    });

    // delete items that are dragged out of the chain
    $('body').droppable({
      drop: function ( event, ui ) {          
        ui.draggable.remove();
      },
      accept: '#chains .effect'
    });
    
    function result(text)
    {
      document.getElementById('result').innerHTML=text;
    }
    
    function send(command,callback)
    {
      command+=';\n';
      console.log(command);
      
      // setup listener for possible incoming result
      if(callback)
        get('/result',callback);
      
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open('PUT','/command',true);  
      xmlHttp.send(command);
    }

    var cmd_element=document.getElementById('command');
    cmd_element.addEventListener('change',function(){
      send(cmd_element.value,result);      
      cmd_element.value='';
    });

    var preview=false;

    var preview_handler=function(){
    
      if(!preview) return;         

      get('/preview',function(data)
      {
        if(data)
          document.getElementById('preview').src=data;
        requestAnimationFrame(preview_handler);          
      });

      send('preview()');
    };
        
    function start_preview(){
      preview=true;
      requestAnimationFrame(preview_handler);
    }
    
    function stop_preview(){
      preview=false;
      document.getElementById('preview').src='';
    }
   
   /*
    TODO
    perspective adjustment UI from index.html:
      var pc=get_cookie('perspective');

    var perspective=pc ? JSON.parse(pc) : [0,0,0,h,w,0,w,h];

    var dragged=false;
    c.canvas.addEventListener('mousedown',function(e){
      if(e.button==1)
        perspective=[0,0,0,h,w,0,w,h];
      else    
        dragged=true;
    });
    c.canvas.addEventListener('mouseup'  ,function(e){dragged=false;});
    c.canvas.addEventListener('mousemove',function(e){
      if(!dragged) return;
      var x=e.offsetX/c.canvas.offsetWidth*w, y=e.offsetY/c.canvas.offsetHeight*h;
      var i=0;
      if(x>w/2) i+=2;
      if(y>h/2) i+=1;
      perspective[i*2]=x;
      perspective[i*2+1]=y;  
      set_cookie('perspective',JSON.stringify(perspective));    
    });
    
    
   */
  </script>

</body>
</html>
