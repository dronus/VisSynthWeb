<!DOCTYPE  html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>NF VisSynth MCP</title>
  <script src="jquery-2.1.4.js"></script>
  <script src="jquery-ui.js"></script>
  <script src="jquery.ui.touch-punch.js"></script>  
</head>
<body style="font-size: 20px;">

  <div class="header container">
    <h1 style="font-size:100%">VIS SYNTH MCP</h1>
    <button onclick="send('document.location.reload()')">RESTART</button>
    <button onclick="screenshot()">SCREENSHOT</button>
    <button onclick="undo()">UNDO</button>    
  </div>

  <div class="effects container">
    <h3>Effects</h3>
    <ul id=effects></ul>
  </div>
  
  <div id="chains">
    <div class="container">
      <h2>Chain 1</h2>
      <ul class="chain"></ul>
    </div>
  </div>
  
  <div class="preview container" onclick="toggle_preview()">
    <button>PREVIEW</button>  
    <img id=preview></img>
    <div id=stats></div>
  </div>
  
  <input type=text id=command></input>        
  <div id=result style="margin: auto; width: 50em;"></div><br>

  <div id=help></div>

  <style>
   body,html{   
      background-color: #000;
      color: #aaa;
      font-family: sans-serif;    
      height: 100%;
      margin: 0px;
      padding: 0px;
      width: 100%;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none; 
  }
  ::-webkit-scrollbar {
    width: 7px;
    height: 7px;
/*    outline-offset: -2px;*/
    outline: 2px solid #000;
  }

  ::-webkit-scrollbar-track {
    background-color: #222;
  }

  ::-webkit-scrollbar-thumb {
    width: 5px;
    background-color: #888;
  }
 
   h1{
    display: inline;
   }
   h2{
    display: block;
    color: #fff;
    margin: 2px;
    font-size: 110%;
   }
   h3{
    display: block;
    color: #fff;
    margin: 2px;
    font-size: 80%;
   }

   button{
      border-radius: 5px;
      background-color: #733;
      color: #fff;
      padding: 8px;
   }
   input{
    color: #fff;
    border:none;
    font-size: 15px;
    width: 40em;
   }   

   .container{
    padding: 5px;
    margin: 2px;
    border-radius: 5px;
    background-color: #000;
   }
   
   .header{
     position: fixed;
     top: 0px;
     left: 0px;
     right: 0px;
     height: 40px;
   }

   #help{
     position: fixed;     
     background-color: rgba(0,0,0,.9);
     color: #aaa;
     font-size: 12px;
     padding: 2px;
     max-width: 400px;
     border-radius: 5px;
     z-index: 100;
     /* allow click-trough to not disturb work flow on touch screens */
     pointer-events:none;
   }
   #help:empty{
    display: none;
   }

   .preview{
      position: fixed;
      bottom: 0px;
      right: 0px;
      width: 320px;
      height: 240px;
   }
   .preview img{
      width: 100%;
   }
   .preview .stats{
      position: absolute; 
      bottom: 10px; left: 10px;
   }
    
   #command{
    display: none;
    position: absolute;
    left: 0px;
    bottom: 0px;
    height: 15px;
    margin: 5px;
   } 
      
   #chains{   
      position: fixed;
      top: 50px;
      bottom: 255px;
      left: 0px;
      right: 0px;
      overflow-x: auto;
      overflow-y: hidden;
      white-space: nowrap;      
    }    
    .effects{
      position: fixed;
      height: 225px;
      bottom: 0px;
      right: 400px;
      overflow-y: auto;
      overflow-x: hidden;
    }    
    #effects{
      margin: 0px;    
      width: 100%;
      list-style: none;
      padding: 0px;
    }
    #effects .effect{
      width: 130px;
      height: 25px;
    }

    #chains>*{
      position:relative;
      background-color: #111;      
      display:inline-block;
      vertical-align: top;
      white-space: normal;
      overflow-x: hidden;
      width:260px; /* leave some space right of effects to act as chain scroll anchor on touch */
      height: calc(100% - 45px); /* leave some empty space below chains to act as chain list scroll anchor on touch */
    }
    
    #chains .active{
      background-color: #030;
    }
    
    /* collapse first empty chain */
    #chains>*:first-child{
      width: 70px;
    }    
    .chain{
      position: absolute;
      top: 32px;
      bottom:0px;
      left:0px;
      right:0px;
      padding: 2px;
      margin: 0px;
      padding-bottom: 50px;
      overflow-x: hidden;
      overflow-y: auto;
    }
    .effect{
      cursor: pointer;
      display: inline-block;
      vertical-align: top;
      list-style: none;    
      background-color: #222;
      color: #fff;
      margin: 2px;
      padding: 3px;
      border-radius: 5px;
      border: 2px solid transparent;
      width: 220px;
      font-size: 10px;
    }

    .effect *{
      vertical-align: top;
    }

    .effect div, .effect span{
      display: inline-block;
    }
    
    .effect .ui_object{
      display: block;
    }

    .effects .key>*, .effects .value>*{
      display: none;
    }
        
    .effect>.ui_object>.value{
      margin-left: 0px;
    }
    .effect>.ui_object>.key
    {
      display: none;
    }
    .effect>.ui_object>.value>:first-child{
      display: block;
    }    
    .effect>.ui_object>.value>:first-child>.key
    {
      display: none;
    }
    .effect>.ui_object>.value>:first-child>.value
    {
      font-size: 15px;
    }
    
    /* show chain flow arrows */
    .chain .effect{
      position:relative;
    }
    /* every effect shows an input arrow be default*/
    .chain .effect::before{
      display: block;
      position:absolute;
      top: -10px;
      left: 50%;
      content: '▾';
    }
    /* effects with more inputs show additional stack input arrows.*/
    .chain .effect[ui_inputs="2"]>.ui_object::before{
      display: block;
      position:absolute;
      top: -3px;
      right: 10px;
      content: '◂▤';
      color: #f00;
    }
    .chain .effect[ui_inputs="3"]>.ui_object::before{
      display: block;
      position:absolute;
      top: -3px;
      right: 10px;
      content: '◂◂▤';
      color: #f00;
    }    
    /* effects with no inputs show no arrows*/
    .chain .effect[ui_inputs="0"]::before{
      display: none;
    }
    /* effects with additional outputs show stack output arrows*/
    .chain .effect[ui_outputs]>.ui_object::before{
      display: block;
      position:absolute;
      bottom: -3px;
      right: 10px;
      content: '▸▤';
      color: #f00;
    }
    /* an effect with no input (source)*/
    .effect[ui_inputs="0"]
    {
      background-color: #242;
    }
    .chain .effect[ui_inputs="0"]
    {
      margin-top: 10px;
    }
    /* an effect sporting additional inputs, pops stack */
    .effect[ui_inputs="2"]
    {
      background: linear-gradient(#522,#222);
    }
    .effect[ui_inputs="3"]
    {
      background: linear-gradient(#622,#222);
    }
    .effect[ui_outputs]
    {
      background: linear-gradient(#222,#522);
    }
    /* an effect manipulating the topmost stack elements */
    .effect[ui_inputs="2"][ui_outputs]
    {
      background: linear-gradient(#522,#222,#522);
    }
    .effect[ui_effect^="feedback"]
    {
      background: #332;
    }
    .effect[ui_effect="preview"]
    {
      background: #531;
    }
                
    .key{
      display: inline-block;
      background-color:#333;
      color: #fff;
      font-size: 10px;
      font-weight: bold;
      margin-right: 5px;
      margin-left: 5px;
    }
    .key::after{
      content: ': '
    }
    .value{
      vertical-align: top;
      color: #fff;
      font-size: 10px;
    }
    .adjust_ui{
      position: fixed;
      width: 750px;
    }
    .adjust_ui .effect{
      width: calc(100% - 20px);
      border-radius: 10px;
      padding: 10px;
      border: 2px solid #999;
      max-height: 90vh;
      overflow: auto;
    }
    .adjust_ui .effect, .effect.ui_target{
      border: 2px solid #f94 !important;
      -webkit-box-shadow: 0px 0px 32px 0px #000;
      -moz-box-shadow: 0px 0px 32px 0px #000;
      box-shadow: 0px 0px 32px 0px #000;
    }    
    .adjust_ui .ui_object .ui_object{      
      border-radius: 5px;
      margin: 5px;
      padding-left: 15px;
      background-color: #444;
    }
    .adjust_ui .ui_object .ui_object .ui_object{
      background-color: #555;
    }
    
    .adjust_ui .ui_number{
      display: block !important;
    }
    .adjust_ui .key{
      color: #fff;
      background-color:transparent;
      width: 60px;
    }
    .adjust_ui input{
      width: 550px;
      height: 40px;
    }
    .adjust_ui .slider_value{
      padding-top: 15px;
      width: 40px;
      font-size: 120%;
    }
    
    .adjust_ui button{
      margin: 2px;
    }
    
  </style>

  <script>
  
    var put=function(url,data)
    {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.responseType='text';
      xmlHttp.open('PUT',url,true);
      xmlHttp.send(data);
    }
    
    var get=function(url,callback)
    {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.responseType='text';
      xmlHttp.open('GET',url,true);
      xmlHttp.onreadystatechange=function()
      {
        if(xmlHttp.readyState!=4) return;
        callback(xmlHttp.responseText);      
      }
      xmlHttp.send(null);      
    }
    
    var undo_history=[];
    var save=function()
    {
      var chains=[];      
      $('#chains .chain').each(function(){
        var chain=[];
        $(this).find('.effect>.ui_object>.value').each(function(){
          var data=get_data($(this));
          chain.push(data);
        });
        if(chain.length) chains.push(chain);
      });
                  
      var json=JSON.stringify(chains);
      put('chains.json',json);      
      undo_history.push(json);
      
      console.log('Saved.');
      
      savetimeout=false;
    }
    
    var get_ui=function(key,node,callback)
    {
      var ui=$('<div>');
      var key_element=$('<span class=key>');
      key_element.html(key);
      ui.append(key_element);
      
      var type=typeof(node);
      ui.addClass('ui_'+type);
      
      var value_element=$('<span class=value>');
      ui.append(value_element);
      if(type=='object')
      {
        if(node.type) ui.attr("ui_type",node.type);
        for(var key2 in node)
        {
          value_element.append(get_ui(key2,node[key2],callback));
        }
      }
      else
      {
        callback(value_element,node);
      }
      
      return ui;
    }
    
    var get_data=function(ui)
    {
      var divs=ui.find('>div');
      var data={};
      divs.each(function(){
        var key=$(this).find('>.key').text();
        var value_element=$(this).find('>.value');
        var value;
        if(value_element.children().length)
          value=get_data(value_element);
        else
        {
          value=value_element.text();
          if($.isNumeric(value)) value=parseFloat(value);
        }
        data[key]=value;
      });
      
      return data;
    }
  
    var create_effect_element=function(effect,value_renderer)
    {
        var li=$('<div class=effect>');
        var effect_template=effects[effect.effect];
        li.attr('ui_effect',effect.effect);
        for(key in effect_template)
          if(key!='args')
            li.attr('ui_'+key, effect_template[key]);
        li.append(get_ui('',effect,value_renderer));
        return li;    
    }
    
    var listEffects=function(effects,container)
    {
      effects.forEach(function(effect){
        var li=create_effect_element(effect,function(element,value){
          element.html(document.createTextNode(''+value));
        });
        $(container).append(li);
      });
    }
      
    var add_slider=function(container,value_element)
    {  
      var slider=$('<span  class=slider_value></span><input class=value_ui type=range min="-0.999" max="0.999" step="0.0002">');
      
      // initalize slider knob with current value 
      var value=value_element.text();
      var slider_value_element=slider.filter('.slider_value');
      slider_value_element.html(value);
      value=logify(value);
      slider.attr('value',value);
      
      var handler=function(){        
        var value=expify(parseFloat(this.value));
        console.log(this.value+" "+value);
        value_element.text(value);
        slider_value_element.html(value);
        updateChain();
      };
      slider.on('input',handler);
      
      if(container) $(container).append(slider);
      
      return slider;      
    }

    var build_ui=function(effect_element){
      effect_element.addClass('ui_target');

      // link value elements to theirself to know the original one to adjust after cloning
      effect_element.find('.value').each(function(){
        // store this element to itself
        $(this).data('original_value_element',this);
      });
      
      // copy the UI with data but without event handlers
      var slider_ui=effect_element.clone(true).off();
      
      slider_ui.find('.ui_number>.value').each(function(){
        var element=$(this);
        var key=element.parent().find('.key').text();
        // get value field of original value_element to manipulate by this UI
        var value_element=$(element.data('original_value_element'));
  
        // if we may adjust a number, add a slider        
        element.empty();
        add_slider(element,value_element);          
      });

      // osc toggler
      var toggle_osc=function(){
        var value_element=$($(this).parent().data('original_value_element'));
        var key=value_element.parent().find('>.key').text();
        
        var new_value;
        if(value_element.parent().attr('ui_type')=='osc')
        {
          // replace OSC by it's pure offset or amplitude value, whats larger.
          var osc=get_data(value_element);
          new_value=Math.abs(osc.a)>Math.abs(osc.o) ? osc.a : osc.o;
        }
        else
        { 
          var offset=parseFloat(value_element.text());
          new_value={type:'osc',f:5.0,a:offset/2,p:0.0,o:offset};
        }
        var new_ui=get_ui(key,new_value,function(element,value){
         element.html(document.createTextNode(''+value));
        });
        value_element.parent().replaceWith(new_ui);

        // update and store effect chain
        updateChain();

        // refresh UI
        container.remove();
        effect_element.click();
      }
      // beat toggler
      var toggle_beat=function(){
        var value_element=$($(this).parent().data('original_value_element'));
        var key=value_element.parent().find('>.key').text();
        
        var new_value;
        if(value_element.parent().attr('ui_type')=='beat')
        {
          // replace BEAT by it's pure offset or amplitude value, whats larger.
          var beat=get_data(value_element);
          new_value=Math.abs(beat.a)>Math.abs(beat.o) ? beat.a : beat.o;
        }
        else
        { 
          var offset=parseFloat(value_element.text());
          new_value={type:'beat',pulse:0.0,f:2.0,a:offset/2,p:0.0,o:offset/2};
        }
        var new_ui=get_ui(key,new_value,function(element,value){
         element.html(document.createTextNode(''+value));
        });
        value_element.parent().replaceWith(new_ui);

        // update and store effect chain
        updateChain();

        // refresh UI
        container.remove();
        effect_element.click();
      }


      slider_ui.find('.ui_object:not([ui_type])>.value>.ui_number>.value').each(function(){
        var element=$(this);
        // get value field of original value_element to manipulate by this UI
        var value_element=$(element.data('original_value_element'));
                  
        element.append($('<button>OSC</button>').click(toggle_osc));
        element.append($('<button>BEAT</button>').click(toggle_beat));
      });
      slider_ui.find('.ui_object[ui_type="osc"]>.value').each(function(){
        var element=$(this);
        element.find('.ui_string').after($('<button>REMOVE OSC</button>').click(toggle_osc));
      });
      slider_ui.find('.ui_object[ui_type="beat"]>.value').each(function(){
        var element=$(this);
        element.find('.ui_string').after($('<button>REMOVE BEAT</button>').click(toggle_beat));
      });

      // add popup container to body
      var container=$('<div class=adjust_ui>');
      container.append(slider_ui);
      $(document.body).append(container);
      container.position({my:'top',at:'bottom',of:$(effect_element),collision:'fit'});
      var close=function(){container.remove();effect_element.removeClass('ui_target');};
      container.on('mouseleave',close);      
      
      // hide popup on outside click too
      $(document).one('mouseclick',function(ev){
        if(!$.contains($('.adjust_ui')[0],ev.target))
          $('.adjust_ui').trigger('mouseleave');
      });
      
    };
    
    
    var add_ui=function(event)
    {
      if($(this).parent().data('prevent_click'))
      {
        $(this).parent().data('prevent_click',false);
        return;
      }
      
      build_ui($(this));
    }

    var markup=function(item){
      item.on('click',add_ui);
    }

    savetimeout=false;
    var updateChain=function(event,ui)
    {
      
      if(savetimeout) clearTimeout(savetimeout);
      savetimeout=setTimeout(save,1000);
      
      
      var chain=[];
      $('#chains .active .effect>.ui_object>.value').each(function(){
        var effect=get_data($(this));
        chain.push(effect);
      });

      send('setChain('+JSON.stringify(chain)+')');
      
      // add empty list, if all are used
      ensure_empty_list();
    }

    var init_chain_list=function(container)
    {
      // the chain list items are sortable
      $(container).sortable({
        distance:10,
        delay:300,
        tolerance: 'pointer',
        stop: updateChain,
        receive: function(event,ui){
          var new_element=$(this).data()['ui-sortable'].currentItem;
          markup(new_element);
          new_element.removeAttr('style'); // remove obsolete jQuery d&d styles
          updateChain(event,ui);
        },
        // allow removal of items by dragging them out        
        over: function(){this.is_outside=false},
        out: function(){this.is_outside=true},
        beforeStop: function(ev,ui){
          $(this).data('prevent_click',true); // store to prevent mouseup click handlers (FF fix)
          if(this.is_outside) 
          {
            $(ui.item).remove();
            updateChain();
          }          
        }
      });
    }
    init_chain_list('.chain');
        
    var empty_list=$('#chains .container').clone();
    
    $('#chains .container').addClass('active');
    
    var ensure_empty_list=function(){
    
      // always keep an empty list at the left
      if(!$('#chains .container:first-child .chain:empty').length)
      {
        $('#chains').prepend(empty_list.clone());
        init_chain_list('#chains .container:first-child .chain');
      }

      // ensure names
      $('#chains .container h2').each(function(i){      
        $(this).html(i==0 ? 'New'  : 'Chain '+i);
      });        
    }
    
    var load=function(json)
    {
      if(!json) return;
      var chains=JSON.parse(json);

      // delete old lists before loading new ones
      $('#chains').empty();
      ensure_empty_list();
      
      chains.forEach(function(chain){
        // move empty list to the end
        $('#chains').append($('#chains .container:first-child'));
        
        var list=$('#chains .container:last-child .chain');
        listEffects(chain,list);
        list.find('.effect').each(function(){
          markup($(this));
        });
        ensure_empty_list();
      });
    }    
    get('chains.json',load);
    
    function undo(){
      undo_history.pop(); // pop last "same" state
      // pop last state
      var last_state=undo_history.pop();
      if(last_state)
      {
        load(last_state);
        updateChain();
      }
    }
             
    var logify=function(x){
//      return(Math.log(Math.abs(x)+1)/Math.LN2*(x>0 ? 1 : -1));
      return (-2+Math.sqrt(x*x+4))/x;
    }
    
    var expify=function(x){    
      return  Math.round((-2/(x+1)-2/(x-1))*1000)/1000;
//      return Math.round((x>0 ? 1 : -1)*(Math.pow(2.,Math.abs(x))-1)*1000.)/1000.;
    }
       
    // build list of effects
    // an effect defines all parameters the UI will show and their default values.
    // the parameters must match the filter functions arguments in order, as they do not take named parameters.
    // additional attributes can be defined for the UI:
    // inputs: n  denotes the number of inputs of the effect. It is expected to pop n-1 stack items! Defaults to 1 if not defined.
    // outputs: n  denotes the number of outputs of the effect. It is expected to push n-1 stack items! Defaults to 1 if not defined.
    // feedback_input:1 denotes the effect reads the feedback buffer from the last frame
    // feedback_output:1 denotes the effect writes the feedback buffer for the next frame
    var effects={
      'capture':{inputs:0,args:{device:0}},
      'matte':{inputs:0, args:{rgb:{type:'rgb', r:0.0,g:1.0,b:1.0}}},      
      'preview':{},
      'stack_push':{outputs:2},
      'stack_swap':{inputs: 2,outputs:2},
       'stack_pop' :{inputs: 2},
      'blend':{inputs: 2,args:{alpha:0.5}},
      'displacement':{inputs: 2,args:{strength:0.05}},
      'blend_alpha':{inputs: 2},
      'transform':{args:{x:0.0,y:0.0,scale:1.0,angle:0.0}},
      'colorkey':{inputs: 2,args:{color:{type:'rgb',r:0.2,g:0.7,b:0.4},threshold:0.2,feather: 0.1}},
      'vibrance':{args:{strength:1.0}},
/*      'brightnessContrast':{args:{brightness:0.0,contrast:0.0},*/
      'brightnessContrast':{args:{brightness:{type:'beat',pulse:0.0,f:2.0,a:1.0,p:0.0,o:-0.7},contrast:0.0}},
      'hueSaturation':{args:{hue:0.0,saturation:0.0}},
      'invertColor':{},
      'noalpha':{},
      'toHSV':{},
      'color':{args:{strength:0.5,rgb:{type:'rgb', r:0.0,g:1.0,b:1.0}}},
      'posterize':{args:{steps:4.0}},
      'coloradjust':{args:{range:{type:'rgb_range',rl:0.0,rr:255.0,gl:0.0,gr:255.0,bl:0.0,br:255.0}}},
      'feedbackOut':{args:{blend:0.7}},
      'feedbackIn':{},
      'polygon':{args:{sides:6.0,x:0.0,y:0.0,size:0.5,angle:0.0}},
      'kaleidoscope':{args:{sides:5.0,angle:{type:'osc',f:5.0,a:1.0,p:0.0,o:0.0},angle2:{type:'osc',f:2.0,a:1.0,p:0.0,o:0.0}}},
      'tile':{args:{divisions:2.0,center:{type:'pos',x:0.0,y:0.0}}},
      'colorHalftone':{args:{center:{type:'pos',x:0,y:0},angle:30.0,size:{type:'osc',f:5.0,a:1.0,p:0.0,o:2.0}}},
      'unsharpMask':{args:{size:3.0,strength:{type:'osc',f:5.0,a:2.0,p:0.0,o:2.0}}},
      'denoise':{args:{strength:10.0}},
      'denoisefast':{args:{strength:30.0}},
      'triangleBlur':{args:{size:10.0}},
      'fastTriangleBlur':{args:{size:10.0}},
      'fastBlur':{args:{size:20.0}},
      'erode':{args:{iterations:2.0}},
      'dilate':{args:{iterations:2.0}},
      'localContrast':{args:{size:10.0,strength:0.5}},
      'zoomBlur':{args:{center:{type:'pos',x:0,y:0}, size: 0.1}},
      'bulgePinch':{args:{center:{type:'pos',x:0,y:0},radius:600,strength:0.2}},
      'swirl':{args:{center:{type:'pos',x:0,y:0},radius:250.0,strength:{type:'osc',f:5.0,a:1.0,p:0.0,o:0.0}}},
      'hexagonalPixelate':{args:{center:{type:'pos',x:0,y:0}, size: 10.0}},
      'grid':{args:{size:1.0,angle:0.0}},
      'life':{},
      'ripple':{args:{width:0.3,length:0.3,angle:0.0,strength:2.0}},
      'gauze':{args:{width:300,length:200,angle:0.0,strength:0.5,center:{type:'pos',x:0.0,y:0.0}}},
      'colorDisplacement':{args:{angle:0.0,strength:3.0}},
      'analogize':{args:{exposure:2.0,gamma:1.5,glow:1.0,glow_radius:16.0}},
      'gamma':{args:{gamma:1.0}},
      'gammaRGB':{args:{rf:1.0,re:1.0,ro:0.0,  gf:1.0,ge:1.0,go:0.0, bf:1.0,be:1.0,bo:0.0}},
      'sobel':{args:{secondary:0.5,coeff:0.5,alpha:0.5,areas:{type:'rgba',r:0,g:0,b:0,a:1},edges:{type:'rgba',r:1,g:1,b:1,a:1}}},
      'motion':{args:{threshold:0.3,interval:1.,damper:0.99}},
      'mandelbrot':{args:{center:{type:'pos',x:0.7,y:0.5},size:3.0,angle:0.0,iterations:10.0}},
      'timeshift':{args:{time:{type:'osc',f:200.0,a:12.5,p:0.0,o:12.5}}},
      'reaction':{args:{noise_factor:0.5,zoom_speed:0.005,scale1:8.0,scale2:16.0,scale3:32.0,scale4:64.0}},
      'relief':{args:{scale2:16.0,scale4:64.0}},
    };
    
    var new_effects=[];
    for(key in effects)
    {
      // create flat object with the effect name in 'effect'
      // like the ones send to the server
      var new_effect={effect:key};
      if(effects[key].args)
        for(i in effects[key].args)
          new_effect[i]=effects[key].args[i];
      new_effects.push(new_effect);
    }
    listEffects(new_effects,'#effects');
        
        
    var last_draggable=false;
    // the effects may be dragged to the chain list
    $('#effects>*').draggable({
      connectToSortable: ".chain",
      appendTo:'body',
      helper: "clone",
      revert: "invalid",
      scroll: false,
      distance: 10,
      delay: 300,
      stop: function(){        
        updateChain();
        last_draggable=false;
      }
    });
    
    // the effects may be cicked to add
    $('#effects>*').on('click',function(){
      var current_chain=$('#chains .active .chain');
      var new_element=$(this).clone();
      current_chain.append(new_element);
      markup(new_element);      
      updateChain();
    });

    var clone_chain=function(chain)
    {
      var new_chain=chain.clone();
      chain.siblings().first().after(new_chain); // insert new chain after the empty list following the current chain position
      new_chain.find('.effect').each(function(){
        markup($(this));
      });
      init_chain_list(new_chain.find('.chain'));
      new_chain.click(); // mark new chain active
    }

    // the chains are sortable...
    $("#chains").sortable({
        handle: 'h2',
        distance:10,
        delay: 300,
        stop:function(ev,ui){
          // if the element is dragged beyond the empty chain to the left, 
          // duplicate it.
          var chain=ui.item;
          if(chain[0].parentNode.firstChild==chain[0])
          {
            $(this).sortable('cancel');  // the original element keeps its position.
            clone_chain(chain);
          }
        },
        // allow removal of items by dragging them out
        over: function(){this.is_outside=false},
        out: function(){this.is_outside=true},
        beforeStop: function(ev,ui){          
          if(this.is_outside) 
          {
            $(ui.item).remove();
            updateChain();
          }
        }
    });
    
    $('#chains').on('click','.container',function(){
      $('#chains .container').removeClass('active');
      $(this).addClass('active');
      updateChain();
    });
    // pressing a number key is like clicking the 0-9 th chain
    $(document).keypress(function(e){
      var number=parseInt(String.fromCharCode(e.which));
      if(number)
        $('#chains .container:nth-child('+(number+1)+')').click();
    });
    

    // add help...

    // a tooltip is shown for any item matching certain selector 
    // the help content is taken from the list in help.html, using
    // the selector set in their help_for attributes to assign it.
    get('/help.html',function(html){
      var help=$(html);
      var helper_timeout=false;
      // each help block is shown for all elements matching it's selector
      help.filter('div').each(function(){
        // read selector from this help block
        var selector=$(this).attr('help_for');
        var text=this;
        // defered event handlers (on body) to assign all future elements as well.
        $(document).on('mouseenter',selector,function(){
          clearTimeout(helper_timeout);
          // add a little delay before showing the tooltip to avoid clutter and permanent CPU stress on mouse motion
          helper_timeout=setTimeout(function(){
            $('#help').html(text);
            $('#help').show();
          },400);
        });
        $(document).on('mouseleave',selector,function(){
          clearTimeout(helper_timeout);
          $('#help').hide();
        });
      });
    });
    // keep help at the mouse        
    $(document).on('mousemove',function(e){
      $('#help').css({left: e.pageX+20, top: e.pageY+20});
    });

    function result(text)
    {
      document.getElementById('result').innerHTML=text;
    }
    
    function send(command,callback)
    {
      command+=';\n';
      
      // setup listener for possible incoming result
      if(callback)
        get('/result',callback);
      
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.responseType='text';
      xmlHttp.open('PUT','/command',true);  
      xmlHttp.send(command);
    }

    var cmd_element=document.getElementById('command');
    cmd_element.addEventListener('change',function(){
      send(cmd_element.value,result);      
      cmd_element.value='';
    });

    var preview=false;

    var preview_handler=function(){
    
      if(!preview) return;         

      get('/preview',function(data)
      {
        if(data)
          document.getElementById('preview').src=data;
        requestAnimationFrame(preview_handler);          
      });
      get('/frame_time',function(data){
        if(data)
          document.getElementById('stats').innerHTML='FPS: '+(Math.round(1000./data));
      });

      send('preview()');
    };
    
    function toggle_preview(){
      preview=!preview;
      if(preview)
        requestAnimationFrame(preview_handler);      
      else
        document.getElementById('preview').src='';
    }
                  
    function screenshot(){
      get('/screenshot',function(data){
        var link=$('<a>');
        link.attr('href',data);
        link.attr('download','screenshot.jpg');
        $(document.body).append(link);
        link[0].click();
        // link.remove();
      });
      send('screenshot()');
    }
   
   
   
   /*
    TODO
    perspective adjustment UI from index.html:
      var pc=get_cookie('perspective');

    var perspective=pc ? JSON.parse(pc) : [0,0,0,h,w,0,w,h];

    var dragged=false;
    c.canvas.addEventListener('mousedown',function(e){
      if(e.button==1)
        perspective=[0,0,0,h,w,0,w,h];
      else    
        dragged=true;
    });
    c.canvas.addEventListener('mouseup'  ,function(e){dragged=false;});
    c.canvas.addEventListener('mousemove',function(e){
      if(!dragged) return;
      var x=e.offsetX/c.canvas.offsetWidth*w, y=e.offsetY/c.canvas.offsetHeight*h;
      var i=0;
      if(x>w/2) i+=2;
      if(y>h/2) i+=1;
      perspective[i*2]=x;
      perspective[i*2+1]=y;  
      set_cookie('perspective',JSON.stringify(perspective));    
    });
    
    
   */
  </script>

</body>
</html>
