<!DOCTYPE  html>
<html>
<head>
  <title>NF VisSynth MCP</title>
  <script src="jquery-2.1.4.js"></script>
  <script src="jquery-ui.js"></script>
  <script src="jquery.ui.touch-punch.js"></script>  
</head>
<body style="font-size: 20px;">

  <div class="header container">
    <h1 style="font-size:100%">VIS SYNTH MCP</h1>
    <button onclick="send('document.location.reload()')">RESTART</button>
    <button onclick="start_preview()">PLAY PREVIEW</button>
    <button onclick="stop_preview()">PAUSE PREVIEW</button>
  </div>


  <div class="effects container">
    <h3>Effects</h3>
    <ul id=effects></ul>
  </div>
  
  <div id="chains">
    <div class="container">
      <h2>Chain 1</h2>
      <ul class="chain"></ul>
    </div>
  </div>
  
  <div class="preview container">
    <img id=preview></img>
  </div>
  
  <input type=text id=command></input>        
  <div id=result style="margin: auto; width: 50em;"></div><br>


  <style>
   body,html{   
      background-color: #000;
      color: #aaa;
      font-family: sans-serif;    
      height: 100%;
      margin: 0px;
      padding: 0px;
      width: 100%;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none; 
  }
  ::-webkit-scrollbar {
    width: 7px;
    height: 7px;
/*    outline-offset: -2px;*/
    outline: 2px solid #000;
  }

  ::-webkit-scrollbar-track {
    background-color: #222;
  }

  ::-webkit-scrollbar-thumb {
    width: 5px;
    background-color: #888;
  }
 
   h1{
    display: inline;
   }
   h2{
    display: block;
    color: #fff;
    margin: 2px;
    font-size: 110%;
   }
   h3{
    display: block;
    color: #fff;
    margin: 2px;
    font-size: 80%;
   }

   button{
      border-radius: 5px;
      background-color: #733;
      color: #fff;
      padding: 8px;
   }
   input{
    color: #fff;
    border:none;
    font-size: 15px;
    width: 40em;
   }   

   .container{
    padding: 5px;
    margin: 2px;
    border-radius: 5px;
    background-color: #000;
   }
   
   .header{
     position: fixed;
     top: 0px;
     left: 0px;
     right: 0px;
     height: 40px;
   }

   .preview{
      position: fixed;
      bottom: 0px;
      right: 0px;
      width: 320px;
      height: 240px;
   }
   .preview img{
      width: 100%;
   }
    
   #command{
    position: absolute;
    left: 0px;
    bottom: 0px;
    height: 15px;
    margin: 5px;
   } 
      
   #chains{   
      position: fixed;
      top: 50px;
      bottom: 255px;
      left: 0px;
      right: 0px;
      overflow-x: auto;
      overflow-y: hidden;
      white-space: nowrap;      
    }    
    .effects{
      position: fixed;
      height: 225px;
      bottom: 15px;
      right: 400px;
      overflow-y: auto;
      overflow-x: hidden;
    }    
    #effects{
      margin: 0px;    
      width: 100%;
      list-style: none;
      padding: 0px;
    }
    #effects .effect{
      width: 140px;
      height: 25px;
    }

    #chains>*{
      position:relative;
      background-color: #111;      
      display:inline-block;
      vertical-align: top;
      white-space: normal;
      overflow-x: hidden;
      width:260px; /* leave some space right of effects to act as chain scroll anchor on touch */
      height: calc(100% - 45px); /* leave some empty space below chains to act as chain list scroll anchor on touch */
    }
    
    #chains .active{
      background-color: #030;
    }
    
    #chains .active .effect{
      background-color: #050;
    }
    /* collapse first empty chain */
    #chains>*:first-child{
      width: 70px;
    }    
    .chain{
      position: absolute;
      top: 32px;
      bottom:0px;
      left:0px;
      right:0px;
      padding: 2px;
      margin: 0px;
      padding-bottom: 50px;
      overflow-x: hidden;
      overflow-y: auto;
    }
    .effect{
      cursor: pointer;
      display: inline-block;
      vertical-align: top;
      list-style: none;    
      background-color: #333;
      color: #fff;
      margin: 2px;
      padding: 3px;
      border-radius: 5px;
      border: 2px solid transparent;
      width: 220px;
      font-size: 10px;
    }

    .effect *{
      vertical-align: top;
    }

    .effect div, .effect span{
      display: inline-block;
    }
    
    .effect .ui_object{
      display: block;
    }

    .effects .key>*, .effects .value>*{
      display: none;
    }
        
    .effect>.ui_object>.value{
      margin-left: 0px;
    }
    .effect>.ui_object>.key
    {
      display: none;
    }
    .effect>.ui_object>.value>:first-child{
      display: block;
    }    
    .effect>.ui_object>.value>:first-child>.key
    {
      display: none;
    }
    .effect>.ui_object>.value>:first-child>.value
    {
      font-size: 15px;
    }
        
    .key{
      display: inline-block;
      background-color:#444;
      color: #fff;
      font-size: 10px;
      font-weight: bold;
      margin-right: 5px;
      margin-left: 5px;
    }
    .key::after{
      content: ': '
    }
    .value{
      vertical-align: top;
      color: #fff;
      font-size: 10px;
    }
    .adjust_ui{
      position: fixed;
      width: 750px;
    }
    .adjust_ui .effect{
      width: calc(100% - 20px);
      border-radius: 10px;
      padding: 10px;
      border: 2px solid #999;
      max-height: 90vh;
      overflow: auto;
    }
    .adjust_ui .ui_object .ui_object{      
      border-radius: 5px;
      margin: 5px;
      padding-left: 15px;
      background-color: #444;
    }
    .adjust_ui .ui_object .ui_object .ui_object{
      background-color: #555;
    }
    
    .adjust_ui .ui_number{
      display: block !important;
    }
    .adjust_ui .key{
      color: #fff;
      background-color:transparent;
      width: 60px;
    }
    .adjust_ui input{
      width: 550px;
      height: 40px;
    }
    .adjust_ui button{
      margin: 2px;
    }
    .effect.ui_target{
      border: 2px solid #f94 !important;
    }
    
  </style>

  <script>
  
    var put=function(url,data)
    {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.responseType='text';
      xmlHttp.open('PUT',url,true);
      xmlHttp.send(data);
    }
    
    var get=function(url,callback)
    {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.responseType='text';
      xmlHttp.open('GET',url,true);
      xmlHttp.onreadystatechange=function()
      {
        if(xmlHttp.readyState!=4) return;
        callback(xmlHttp.responseText);      
      }
      xmlHttp.send(null);      
    }
    
    var save=function()
    {
      var chains=[];      
      $('#chains .chain').each(function(){
        var chain=[];
        $(this).find('.effect>.ui_object>.value').each(function(){
          var data=get_data($(this));
          chain.push(data);
        });
        if(chain.length) chains.push(chain);
      });
                  
      var json=JSON.stringify(chains);
      put('chains.json',json);
      
      console.log('Saved.');
      
      savetimeout=false;
    }
    
    var get_ui=function(key,node,callback)
    {
      var ui=$('<div>');
      var key_element=$('<span class=key>');
      key_element.html(key);
      ui.append(key_element);
      
      var type=typeof(node);
      ui.addClass('ui_'+type);
      
      var value_element=$('<span class=value>');
      ui.append(value_element);
      if(type=='object')
      {
        if(node.type) ui.attr("ui_type",node.type);
        for(var key2 in node)
        {
          value_element.append(get_ui(key2,node[key2],callback));
        }
      }
      else
      {
        callback(value_element,node);
      }
      
      return ui;
    }
    
    var get_data=function(ui)
    {
      var divs=ui.find('>div');
      var data={};
      divs.each(function(){
        var key=$(this).find('>.key').text();
        var value_element=$(this).find('>.value');
        var value;
        if(value_element.children().length)
          value=get_data(value_element);
        else
        {
          value=value_element.text();
          if($.isNumeric(value)) value=parseFloat(value);
        }
        data[key]=value;
      });
      
      return data;
    }
  
    var create_effect_element=function(effect,value_renderer)
    {
        var li=$('<div class=effect>');
        li.append(get_ui('',effect,value_renderer));
        return li;    
    }
    
    var listEffects=function(effects,container)
    {
      effects.forEach(function(effect){
        var li=create_effect_element(effect,function(element,value){
          element.html(document.createTextNode(''+value));
        });
        $(container).append(li);
      });
    }
      
    var add_slider=function(container,value_element)
    {  
      var slider=$('<input class=value_ui type=range min="-10" max="10" step="0.01">');
      
      // initalize slider knob with current value 
      var value=value_element.text();
      value=logify(value);
      slider.attr('value',value);
      
      var handler=function(){
        var value=expify(this.value);
        value_element.text(value);
        updateChain();
      };
      slider.on('input',handler);
      
      if(container) $(container).append(slider);
      
      return slider;      
    }

    var build_ui=function(effect_element){
      effect_element.addClass('ui_target');

      // link value elements to theirself to know the original one to adjust after cloning
      effect_element.find('.value').each(function(){
        // store this element to itself
        $(this).data('original_value_element',this);
      });
      
      // copy the UI with data but without event handlers
      var slider_ui=effect_element.clone(true).off();
      
      slider_ui.find('.ui_number>.value').each(function(){
        var element=$(this);
        var key=element.parent().find('.key').text();
        // get value field of original value_element to manipulate by this UI
        var value_element=$(element.data('original_value_element'));
  
        // if we may adjust a number, add a slider        
        element.empty();
        add_slider(element,value_element);          
      });

      // osc toggler
      var toggle_osc=function(){
        var value_element=$($(this).parent().data('original_value_element'));
        var key=value_element.parent().find('>.key').text();
        
        var new_value;
        if(value_element.parent().attr('ui_type')=='osc')
        {
          // replace OSC by it's pure offset or amplitude value, whats larger.
          var osc=get_data(value_element);
          new_value=Math.abs(osc.a)>Math.abs(osc.o) ? osc.a : osc.o;
        }
        else
        { 
          var offset=parseFloat(value_element.text());
          new_value={type:'osc',f:5.0,a:offset/2,p:0.0,o:offset};
        }
        var new_ui=get_ui(key,new_value,function(element,value){
         element.html(document.createTextNode(''+value));
        });
        value_element.parent().replaceWith(new_ui);

        // update and store effect chain
        updateChain();

        // refresh UI
        container.remove();
        effect_element.click();
      }
      slider_ui.find('.ui_object:not([ui_type="osc"])>.value>.ui_number>.value').each(function(){
        var element=$(this);
        // get value field of original value_element to manipulate by this UI
        var value_element=$(element.data('original_value_element'));
                  
        element.append($('<button>OSC</button>').click(toggle_osc));
      });
      slider_ui.find('.ui_object[ui_type="osc"]>.value').each(function(){
        var element=$(this);
        // get value field of original value_element to manipulate by this UI
        var value_element=$(element.data('original_value_element'));
  
        element.find('.ui_string').after($('<button>REMOVE OSC</button>').click(toggle_osc));
      });

      // add popup container to body
      var container=$('<div class=adjust_ui>');
      container.append(slider_ui);
      $(document.body).append(container);
      container.position({my:'top',at:'bottom',of:$(effect_element),collision:'fit'});
      var close=function(){container.remove();effect_element.removeClass('ui_target');};
      container.on('mouseleave',close);      

      $(document).one('mouseup',function(ev){
        if(!$.contains($('.adjust_ui')[0],ev.target))
          $('.adjust_ui').trigger('mouseleave');
      });
    };
    
    
    var add_ui=function(event)
    {
      build_ui($(this));
    }

    var markup=function(item){
      item.on('click',add_ui);
    }

    savetimeout=false;
    var updateChain=function(event,ui)
    {
      
      if(savetimeout) clearTimeout(savetimeout);
      savetimeout=setTimeout(save,1000);
      
      
      var chain=[];
      $('#chains .active .effect>.ui_object>.value').each(function(){
        var effect=get_data($(this));
        chain.push(effect);
      });

      send('setChain('+JSON.stringify(chain)+')');
      
      // add empty list, if all are used
      ensure_empty_list();
    }

    var init_chain_list=function(container)
    {
      // the chain list items are sortable
      $(container).sortable({
        distance:10,
        delay:300,
        tolerance: 'pointer',
        stop: updateChain,
        receive: function(event,ui){
          var new_element=$(this).data()['ui-sortable'].currentItem;
          markup(new_element);
          new_element.removeAttr('style'); // remove obsolete jQuery d&d styles
          updateChain(event,ui);
        },
        // allow removal of items by dragging them out        
        over: function(){this.is_outside=false},
        out: function(){this.is_outside=true},
        beforeStop: function(ev,ui){
          if(this.is_outside) 
          {
            $(ui.item).remove();
            updateChain();
          }
        }
      });
    }
    init_chain_list('.chain');
        
    var empty_list=$('#chains .container').clone();
    
    $('#chains .container').addClass('active');
    
    var ensure_empty_list=function(){
    
      // always keep an empty list at the left
      if(!$('#chains .container:first-child .chain:empty').length)
      {
        $('#chains').prepend(empty_list.clone());
        init_chain_list('#chains .container:first-child .chain');
      }
      
      // ensure names
      $('#chains .container h2').each(function(i){      
        $(this).html(i==0 ? 'New'  : 'Chain '+i);
      });        
    }
    
    var load=function(json)
    {
      if(!json) return;
      var chains=JSON.parse(json);
      
      
      chains.forEach(function(chain){
        // move empty list to the end
        $('#chains').append($('#chains .container:first-child'));
        
        var list=$('#chains .container:last-child .chain');
        listEffects(chain,list);
        list.find('.effect').each(function(){
          markup($(this));
        });
        ensure_empty_list();
      });
      
      
    }    
    get('chains.json',load);
    
    var logify=function(x){
      return(Math.log(Math.abs(x)+1)/Math.LN2*(x>0 ? 1 : -1));
    }
    
    var expify=function(x){
      return Math.round((x>0 ? 1 : -1)*(Math.pow(2.,Math.abs(x))-1)*100.)/100.;
    }
       
    $("ul, li").disableSelection();

    // build list of effects  
    var effects=[
      {effect:'capture'},
      {effect:'stack_push'},
      {effect:'stack_pop'},
      {effect:'blend',type:'2',alpha:1.0},
      {effect:'blend_alpha',type:'3'},
      {effect:'colorkey',color:{type:'rgb',r:0.2,g:0.7,b:0.4},threshold:0.2,feather: 0.1},      
      {effect:'vibrance',strength:1.0},
      {effect:'brightnessContrast',brightness:0.0,contrast:0.0},
      {effect:'hueSaturation',hue:0.0,saturation:0.0},
      {effect:'invertColor'},
      {effect:'toHSV'},
      {effect:'color',strength:0.5,rgb:{type:'rgb', r:0.0,g:1.0,b:1.0}},
      {effect:'coloradjust',range:{type:'rgb_range',rl:0.0,rr:255.0,gl:0.0,gr:255.0,bl:0.0,br:255.0}},
      {effect:'feedbackOut',blend:0.7},
      {effect:'feedbackIn'},
      {effect:'kaleidoscope',sides:5.0,angle:{type:'osc',f:5.0,a:1.0,p:0.0,o:0.0},angle2:{type:'osc',f:2.0,a:1.0,p:0.0,o:0.0}},
      {effect:'tile',divisions:2.0,center:{type:'pos',x:0.0,y:0.0}},
      {effect:'colorHalftone',center:{type:'pos',x:0,y:0},angle:30.0,size:{type:'osc',f:5.0,a:1.0,p:0.0,o:2.0}},
      {effect:'unsharpMask',size:3.0,strength:{type:'osc',f:5.0,a:2.0,p:0.0,o:2.0}},
      {effect:'denoise',strength:10.0},
      {effect:'denoisefast',strength:30.0},
      {effect:'triangleBlur',size:10.0},
      {effect:'fastTriangleBlur',size:10.0},      
      {effect:'fastBlur',size:10.0,strength:0.8},
      {effect:'zoomBlur',center:{type:'pos',x:0,y:0}, size: 0.1},
      {effect:'bulgePinch',center:{type:'pos',x:0,y:0},radius:600,strength:0.2},
      {effect:'swirl',center:{type:'pos',x:0,y:0},radius:250.0,strength:{type:'osc',f:5.0,a:1.0,p:0.0,o:0.0}},
      {effect:'hexagonalPixelate',center:{type:'pos',x:0,y:0}, size: 10.0},
      {effect:'grid',size:1.0,angle:0.0},
      {effect:'life'},
      {effect:'ripple',width:0.3,length:0.3,angle:0.0,strength:2.0},
      {effect:'gauze',width:300,length:200,angle:0.0,strength:0.5,center:{type:'pos',x:0.0,y:0.0}},
      {effect:'colorDisplacement',angle:0.0,strength:3.0},
      {effect:'analogize',exposure:2.0,gamma:1.5,glow:1.0,glow_radius:16.0},
      {effect:'gamma',factor:1.0,exponent:1.0,offset:0.0},
      {effect:'gammaRGB',rf:1.0,re:1.0,ro:0.0,  gf:1.0,ge:1.0,go:0.0, bf:1.0,be:1.0,bo:0.0},
      {effect:'sobel',secondary:0.5,coeff:0.5,alpha:0.5,areas:{type:'rgba',r:0,g:0,b:0,a:1},edges:{type:'rgba',r:1,g:1,b:1,a:1}},
      {effect:'motion',threshold:0.3,interval:1.,damper:0.99},
      {effect:'mandelbrot',center:{type:'pos',x:0.7,y:0.5},size:3.0,angle:0.0,iterations:10.0},
      {effect:'timeshift',time:{type:'osc',f:200.0,a:12.5,p:0.0,o:12.5}},
    ];
    listEffects(effects,'#effects');
        
        
    var last_draggable=false;
    // the effects may be dragged to the chain list
    $('#effects>*').draggable({
      connectToSortable: ".chain",
      appendTo:'body',
      helper: "clone",
      revert: "invalid",
      scroll: false,
      distance: 10,
      delay: 300,
      stop: function(){        
        updateChain();
        last_draggable=false;
      }
    });

    // the chains are sortable...
    $("#chains").sortable({
        handle: 'h2',
        distance:10,
        delay: 300,
        stop:function(){updateChain()},
        // allow removal of items by dragging them out
        over: function(){this.is_outside=false},
        out: function(){this.is_outside=true},
        beforeStop: function(ev,ui){          
          if(this.is_outside) 
          {
            $(ui.item).remove();
            updateChain();
          }
        }
    });
    
    $('#chains').on('click','.container',function(){
      $('#chains .container').removeClass('active');
      $(this).addClass('active');
      updateChain();
    });

    function result(text)
    {
      document.getElementById('result').innerHTML=text;
    }
    
    function send(command,callback)
    {
      command+=';\n';
      console.log(command);
      
      // setup listener for possible incoming result
      if(callback)
        get('/result',callback);
      
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.responseType='text';
      xmlHttp.open('PUT','/command',true);  
      xmlHttp.send(command);
    }

    var cmd_element=document.getElementById('command');
    cmd_element.addEventListener('change',function(){
      send(cmd_element.value,result);      
      cmd_element.value='';
    });

    var preview=false;

    var preview_handler=function(){
    
      if(!preview) return;         

      get('/preview',function(data)
      {
        if(data)
          document.getElementById('preview').src=data;
        requestAnimationFrame(preview_handler);          
      });

      send('preview()');
    };
        
    function start_preview(){
      preview=true;
      requestAnimationFrame(preview_handler);
    }
    
    function stop_preview(){
      preview=false;
      document.getElementById('preview').src='';
    }
   
   /*
    TODO
    perspective adjustment UI from index.html:
      var pc=get_cookie('perspective');

    var perspective=pc ? JSON.parse(pc) : [0,0,0,h,w,0,w,h];

    var dragged=false;
    c.canvas.addEventListener('mousedown',function(e){
      if(e.button==1)
        perspective=[0,0,0,h,w,0,w,h];
      else    
        dragged=true;
    });
    c.canvas.addEventListener('mouseup'  ,function(e){dragged=false;});
    c.canvas.addEventListener('mousemove',function(e){
      if(!dragged) return;
      var x=e.offsetX/c.canvas.offsetWidth*w, y=e.offsetY/c.canvas.offsetHeight*h;
      var i=0;
      if(x>w/2) i+=2;
      if(y>h/2) i+=1;
      perspective[i*2]=x;
      perspective[i*2+1]=y;  
      set_cookie('perspective',JSON.stringify(perspective));    
    });
    
    
   */
  </script>

</body>
</html>
