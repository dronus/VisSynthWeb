<!DOCTYPE  html>
<html>
<head>
  <title>NF VisSynth MCP</title>
</head>
<body style="font-size: 30px;">
  <h1 style="font-size:100%">NF VIS SYNTH MASTER CONTROL PROGRAM</h1>
  <input type=text id=command style="margin: auto; width: 50em;"></input><br>
  <button onclick="send('document.location.reload()')">RESTART</button>
  |
  <button onclick="send('prev()')">PREV</button>
  <button onclick="send('next()')">NEXT</button>
  |
  <button onclick="send('start('+parseFloat(document.getElementById('delay').value)*1000+')')">START</button>
  <input type=text id=delay style="width: 5em;" value=10>
  <button onclick="send('stop()')">STOP</button>
  
  <br>
  <button onclick="start_preview()">PLAY PREVIEW</button>
  <button onclick="stop_preview()">PAUSE PREVIEW</button>
  <br>
  <img id=preview></img>

  <script>    
    function send(command)
    {
      command+=';\n';
      console.log(command);
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open('PUT','/command',true);  
      xmlHttp.send(command);
    }

    var cmd_element=document.getElementById('command');
    cmd_element.addEventListener('change',function(){
      send(cmd_element.value);      
      cmd_element.value='';
    });


    var preview=false;

    var preview_handler=function(){
    
      if(!preview) return;
    
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open('GET','/preview',false);
      xmlHttp.onreadystatechange=function()
      {
        if(xmlHttp.readyState!=4) return;
        var dataUrl=xmlHttp.responseText;
        if(dataUrl)
          document.getElementById('preview').src=dataUrl;

        send('preview()');
      }
      xmlHttp.send(null);
      
      requestAnimationFrame(preview_handler);
    };
        
    function start_preview(){
      preview=true;
      send('preview()');
      requestAnimationFrame(preview_handler);
    }
    
    function stop_preview(){
      preview=false;
      document.getElementById('preview').src='';
    }
   
   /*
    TODO
    perspective adjustment UI from index.html:
    	var pc=get_cookie('perspective');

		var perspective=pc ? JSON.parse(pc) : [0,0,0,h,w,0,w,h];

		var dragged=false;
		c.canvas.addEventListener('mousedown',function(e){
			if(e.button==1)
				perspective=[0,0,0,h,w,0,w,h];
			else		
				dragged=true;
		});
		c.canvas.addEventListener('mouseup'  ,function(e){dragged=false;});
		c.canvas.addEventListener('mousemove',function(e){
			if(!dragged) return;
			var x=e.offsetX/c.canvas.offsetWidth*w, y=e.offsetY/c.canvas.offsetHeight*h;
			var i=0;
			if(x>w/2) i+=2;
			if(y>h/2) i+=1;
			perspective[i*2]=x;
			perspective[i*2+1]=y;	
			set_cookie('perspective',JSON.stringify(perspective));		
		});
		
		
   */
  </script>

</body>
</html>
