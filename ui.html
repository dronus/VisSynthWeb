<!DOCTYPE  html>
<html>
<head>
  <title>NF VisSynth MCP</title>
  <script src="jquery-2.1.4.js"></script>
  <script src="jquery-ui.js"></script>
</head>
<body style="font-size: 20px;">

  <div class="header container">
    <h1 style="font-size:100%">VIS SYNTH MCP</h1>
    <button onclick="send('document.location.reload()')">RESTART</button>
    <button onclick="start_preview()">PLAY PREVIEW</button>
    <button onclick="stop_preview()">PAUSE PREVIEW</button>
  </div>


  <div class="effects container">
    <h3>Effects</h3>
    <ul id=effects></ul>
  </div>
  
  <div id="chains">
    <div class="container">
      <h2>Chain 1</h2>
      <ul class="chain"></ul>
    </div>
  </div>
  
  <div class="preview container">
    <img id=preview></img>
  </div>
  
  <input type=text id=command></input>        
  <div id=result style="margin: auto; width: 50em;"></div><br>


  <style>
   body,html{   
      background-color: #000;
      color: #aaa;
      font-family: sans-serif;    
      height: 100%;
      margin: 0px;
      padding: 0px;
      width: 100%;
   }
   
  ::-webkit-scrollbar {
    width: 7px;
    height: 7px;
/*    outline-offset: -2px;*/
    outline: 2px solid #000;
  }

  ::-webkit-scrollbar-track {
    background-color: #222;

  }

  ::-webkit-scrollbar-thumb {
    width: 5px;
    background-color: #888;
  }
   
   h1{
    display: inline;
   }
   h2{
    display: block;
    color: #fff;
    margin: 2px;
    font-size: 110%;
   }
   h3{
    display: block;
    color: #fff;
    margin: 2px;
    font-size: 80%;
   }

   button{
      border-radius: 5px;
      background-color: #733;
      color: #fff;
      padding: 8px;
   }
   input{
    background-color: #333;
    color: #fff;
    border:none;
    font-size: 15px;
    width: 40em;
   }   

   .container{
    padding: 5px;
    margin: 2px;
    border-radius: 5px;
    background-color: #000;
   }
   
   .header{
     position: fixed;
     top: 0px;
     left: 0px;
     right: 0px;
     height: 40px;
   }

   .preview{
      position: fixed;
      bottom: 0px;
      right: 0px;
      width: 320px;
      height: 240px;
   }
   .preview img{
      width: 100%;
   }
    
   #command{
    position: absolute;
    left: 0px;
    bottom: 0px;
    height: 15px;
    margin: 5px;
   } 
      
   #chains{   
      position: fixed;
      top: 50px;
      bottom: 255px;
      left: 0px;
      right: 0px;
      overflow-x: auto;
      overflow-y: hidden;
      white-space: nowrap;      
    }    
    .effects{
      position: fixed;
      height: 225px;
      bottom: 15px;
      right: 400px;
      overflow-y: auto;
      overflow-x: hidden;
    }    
    #effects{
      margin: 0px;    
      width: 100%;
      list-style: none;
      padding: 0px;
    }
    #effects .effect{
      width: 140px;
      height: 25px;
    }

    #chains>*{
      position:relative;
      background-color: #111;      
      display:inline-block;
      vertical-align: top;
      white-space: normal;
      overflow-x: hidden;
      width:240px;
      height: calc(100% - 17px);
    }
    
    #chains .active{
      background-color: #030;
    }
    
    #chains .active .effect{
      background-color: #050;
    }
    
    .chain{
      position: absolute;
      top: 32px;
      bottom:0px;
      left:0px;
      right:0px;
      padding: 2px;
      margin: 0px;
      padding-bottom: 50px;
      overflow-y: auto;
    }
    .effect{
      display: inline-block;
      vertical-align: top;
      list-style: none;    
      background-color: #333;
      color: #fff;
      margin: 2px;
      padding: 5px;
      border-radius: 5px;
      width: 220px;
      font-size: 10px;
    }

    .effect div{
      display: inline-block;
      vertical-align: top;
    }
    
    .effect .ui_object{
      display: block;
    }

    .effects .key>*, .effects .value>*{
      display: none;
    }
        
    .effect>.ui_object>.value{
      margin-left: 0px;
    }
    .effect>.ui_object>.key
    {
      display: none;
    }
    .effect>.ui_object>.value>:first-child{
      display: block;
    }    
    .effect>.ui_object>.value>:first-child>.key
    {
      display: none;
    }
    .effect>.ui_object>.value>:first-child>.value
    {
      font-size: 15px;
    }
        
    .key{
      display: inline-block;
      background-color:#444;
      color: #fff;
      font-size: 10px;
      font-weight: bold;
      margin-right: 5px;
      margin-left: 5px;
    }
    .key::after{
      content: ': '
    }
    .value{
      vertical-align: top;
      color: #f94;
      font-size: 10px;
    }
    .adjust_ui{
      position: fixed;
      background-color: #444;
      border-radius: 10px;
      padding: 10px;
      width: 550px;
      border: 2px solid #999;
    }
    .adjust_ui label{
      vertical-align: top;
      color: #fff;
      display: inline-block;
      width: 100px;
    }
    .adjust_ui input{      
      width: 400px;
      height: 40px;
    }
    #chains .active .effect.ui_target{
      border-color: #fff;
    }
    
  </style>

  <script>
  
    var put=function(url,data)
    {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open('PUT',url,true);
      xmlHttp.send(data);
    }
    
    var get=function(url,callback)
    {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open('GET',url,true);
      xmlHttp.onreadystatechange=function()
      {
        if(xmlHttp.readyState!=4) return;
        callback(xmlHttp.responseText);      
      }
      xmlHttp.send(null);      
    }
    
    var save=function()
    {
      var chains=[];      
      $('#chains .chain').each(function(){
        var chain=[];
        $(this).find('.effect>.ui_object>.value').each(function(){
          var data=get_data($(this));
          chain.push(data);
        });
        if(chain.length) chains.push(chain);
      });
                  
      var json=JSON.stringify(chains);
      put('chains.json',json);
      
      console.log('Saved.');
      
      savetimeout=false;
    }
    
    var get_ui=function(key,node)
    {
      var ui=$('<div>');
      var key_element=$('<span class=key>');
      key_element.html(key);
      ui.append(key_element);
      
      var type=typeof(node);
      ui.addClass('ui_'+type);
      
      var value_element=$('<span class=value>');      
      ui.append(value_element);
      if(type=='object')
      {
        for(var key2 in node)
        {
          value_element.append(get_ui(key2,node[key2]));
        }
      }
      else
      {
        value_element.html(document.createTextNode(''+node));
      }
      
      return ui;
    }
    
    var get_data=function(ui)
    {
      var divs=ui.find('>div');
      var data={};
      divs.each(function(){
        var key=$(this).find('>.key').text();
        var value_element=$(this).find('>.value');
        var value;
        if(value_element.children().length)
          value=get_data(value_element);
        else
          value=value_element.text();
        data[key]=value;
      });
      
      return data;
    }
    
    var listEffects=function(effects,container)
    {
      effects.forEach(function(effect){        
        var li=$('<li class=effect>');
        li.append(get_ui('',effect));
        $(container).append(li);
      });
    }
      
    var add_slider=function(element,value,callback)
    {
      var slider=$('<input class=value_ui type=range min="-10" max="10" step="0.01">');
      slider.attr('value',value);
      slider.on('input',callback);
      
      if(element) $(element).append(slider);
      //slider.position({my:'top',at:'bottom',of:$(value_element)});
      
      return slider;      
    }

    var build_ui=function(effect){
      effect.addClass('ui_target');
      var container=$('<div class=adjust_ui>');
      $(document.body).append(container);
      container.position({my:'top',at:'bottom',of:$(effect)});
      container.on('mouseleave',function(){container.remove();effect.removeClass('ui_target');});
           
      effect.find('.value').each(function(){
        var element=$(this);
        var key  =element.parent().find('.key').text();        
        var value=element.text();
        if($.isNumeric(value))
        {
          container.append($('<label>').text(key));
          add_slider(container,logify(value),function(){
            var v=expify(this.value);
            element.text(v);
            updateChain();
          });
        }
      });
    };
    
    var add_ui=function(event)
    {
      build_ui($(this));
    }

    var markup=function(item){
      item.on('click',add_ui);
    }

    var flatten=function(o){
      var a=[];
      for(var key in o) if(key!='type') a.push(o[key]);
      return a.join(',');
    }
    
          // generators...
    var generators={
      osc:function(args){return [args.a+"*Math.sin(t*"+args.f+"+"+args.p+")+"+args.o]},
      pos:function(args){return [args.x+"+w/2",args.y+"+h/2"]},
      size:flatten,
      rgb:flatten,
      rgba:flatten,
      rgb_range:flatten
    };
    
    var generate_command=function(effect){
    
      var command=effect.effect;
      var args=[];
      for(var key in effect)
      {
        if(key=='effect') continue;
        var value=effect[key];
        if(typeof(value)=='object')
          args=args.concat(generators[value.type](value));
        else
          args.push(value);
      }
                                  
      var code=command+'('+args.join(',')+')';
            
      return code;
    }

    savetimeout=false;
    var updateChain=function(event,ui)
    {
      
      if(savetimeout) clearTimeout(savetimeout);
      savetimeout=setTimeout(save,1000);
      
      
      var chain='';
      $('#chains .active .effect>.ui_object>.value').each(function(){
        var effect=get_data($(this));
        chain+=generate_command(effect)+';';
      });

      send('setChain("'+chain+'")');
      
      // add empty list, if all are used
      ensure_empty_list();
    }

    var init_chain_list=function(container)
    {
      // the chain list items are sortable
      $(container).sortable({
        //revert: true,
        tolerance: 'pointer',
        stop: updateChain,
        receive: function(event,ui){
          markup($(this).data()['ui-sortable'].currentItem);
          updateChain(event,ui);
        }
      }).droppable({greedy: true});      
    }
    init_chain_list('.chain');
        
    var empty_list=$('#chains .container').clone();
    
    $('#chains .container').addClass('active');
    
    var ensure_empty_list=function(){
      // delete surplus empty lists
      $('#chains .container').has('.chain:empty').remove();
      
      // add another empty list
      $('#chains').prepend(empty_list.clone());
      init_chain_list('#chains .container:first-child .chain');
      
      // ensure names
      $('#chains .container h2').each(function(i){
        $(this).html('Chain '+(i+1));
      });        
    }
    
    var load=function(json)
    {
      if(!json) return;
      var chains=JSON.parse(json);
      
      
      chains.forEach(function(chain){
        // move empty list to the end
        $('#chains').append($('#chains .container:first-child'));
        
        var list=$('#chains .container:last-child .chain');
        listEffects(chain,list);
        list.find('.effect').each(function(){
          markup($(this));
        });
        ensure_empty_list();
      });
      
      
    }    
    get('chains.json',load);
    
    var logify=function(x){
      return(Math.log(Math.abs(x)+1)/Math.LN2*(x>0 ? 1 : -1));
    }
    
    var expify=function(x){
      return Math.round((x>0 ? 1 : -1)*(Math.pow(2.,Math.abs(x))-1)*100.)/100.;
    }
       
    $("ul, li").disableSelection();

    // build list of effects  
    var effects=[
      {effect:'vibrance',strength:1.0},
      {effect:'brightnessContrast',brightness:0.0,contrast:0.0},
      {effect:'hueSaturation',hue:0.0,saturation:0.0},
      {effect:'invertColor'},
      {effect:'toHSV'},
      {effect:'color',strength:0.5,rgb:{type:'rgb', r:0.0,g:1.0,b:1.0}},
      {effect:'coloradjust',range:{type:'rgb_range',rl:0.0,rr:255.0,gl:0.0,gr:255.0,bl:0.0,br:255.0}},
      {effect:'feedbackOut',blend:0.7},
      {effect:'feedbackIn'},
      {effect:'kaleidoscope',sides:5.0,angle:{type:'osc',f:5.0,a:1.0,p:0.0,o:0.0},angle2:{type:'osc',f:2.0,a:1.0,p:0.0,o:0.0}},
      {effect:'tile',divisions:2.0},
      {effect:'colorHalftone',center:{type:'pos',x:0,y:0},angle:30.0,size:{type:'osc',f:5.0,a:1.0,p:0.0,o:2.0}},
      {effect:'unsharpMask',size:3.0,strength:{type:'osc',f:5.0,a:2.0,p:0.0,o:2.0}},
      {effect:'denoise',strength:10.0},
      {effect:'denoisefast',strength:30.0},
      {effect:'triangleBlur',size:10.0},
      {effect:'zoomBlur',center:{type:'pos',x:0,y:0}, size: 0.1},
      {effect:'bulgePinch',center:{type:'pos',x:0,y:0},radius:600,strength:0.2},
      {effect:'swirl',center:{type:'pos',x:0,y:0},radius:250.0,strength:{type:'osc',f:5.0,a:1.0,p:0.0,o:0.0}},
      {effect:'hexagonalPixelate',center:{type:'pos',x:0,y:0}, size: 10.0},
      {effect:'grid',size:1.0,angle:0.0},
      {effect:'life'},
      {effect:'ripple',width:0.3,length:0.3,angle:0.0,strength:2.0},
      {effect:'colorDisplacement',angle:0.0,strength:3.0},
      {effect:'analogize',exposure:2.0,gamma:1.5,glow:1.0,glow_radius:16.0},
      {effect:'gamma',factor:1.0,exponent:1.0,offset:0.0},
      {effect:'gammaRGB',rf:1.0,re:1.0,ro:0.0,  gf:1.0,ge:1.0,go:0.0, bf:1.0,be:1.0,bo:0.0},
      {effect:'sobel',secondary:0.5,coeff:0.5,alpha:0.5,areas:{type:'rgba',r:0,g:0,b:0,a:1},edges:{type:'rgba',r:1,g:1,b:1,a:1}},
      {effect:'motion',threshold:0.3,interval:1.,damper:0.99},
    ];
    listEffects(effects,'#effects');
        
        
    var last_draggable=false;
    // the effects may be dragged to the chain list
    $('#effects>*').draggable({
      connectToSortable: ".chain",
      appendTo:'body',
      helper: "clone",
      revert: "invalid",
      scroll: false,
      stop: function(){
        updateChain();
        last_draggable=false;
      },           
/*      start: function(ev,ui){
        // part of fix for jQuerys drop zones also intersect elements hidden by overflow:hidden / overflow:scroll
        last_draggable=$(this).data('ui-draggable');
        last_draggable.last_sortables=last_draggable.sortables;
        last_draggable.sortables=[];        
      }*/
    });
        
    // part of fix for jQuerys drop zones also intersect elements hidden by overflow:hidden / overflow:scroll
    // we only may drop into the sortables, if the draggable helper has entered the parent container
/*    $('#chains').droppable({'over':function(){
        if(!last_draggable || !last_draggable.last_sortables) return;
        last_draggable.sortables=last_draggable.last_sortables;
        last_draggable.last_sortables=false;
    }
    ,refreshPositions:true
    });
  */      
    //$('#effects').droppable({greedy:true});

    // the chains are sortable...
    $("#chains").sortable({
//      stop: updateChains 
    });
    
    $('#chains').on('click','.container',function(){
      $('#chains .container').removeClass('active');
      $(this).addClass('active');
      updateChain();
    });

    // delete items that are dragged out of the chain
    $('body').droppable({
      drop: function ( event, ui ) {          
        ui.draggable.remove();
      },
      accept: '#chains .effect'
    });
    
    function result(text)
    {
      document.getElementById('result').innerHTML=text;
    }
    
    function send(command,callback)
    {
      command+=';\n';
      console.log(command);
      
      // setup listener for possible incoming result
      if(callback)
        get('/result',callback);
      
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open('PUT','/command',true);  
      xmlHttp.send(command);
    }

    var cmd_element=document.getElementById('command');
    cmd_element.addEventListener('change',function(){
      send(cmd_element.value,result);      
      cmd_element.value='';
    });

    var preview=false;

    var preview_handler=function(){
    
      if(!preview) return;         

      get('/preview',function(data)
      {
        if(data)
          document.getElementById('preview').src=data;
        requestAnimationFrame(preview_handler);          
      });

      send('preview()');
    };
        
    function start_preview(){
      preview=true;
      requestAnimationFrame(preview_handler);
    }
    
    function stop_preview(){
      preview=false;
      document.getElementById('preview').src='';
    }
   
   /*
    TODO
    perspective adjustment UI from index.html:
      var pc=get_cookie('perspective');

    var perspective=pc ? JSON.parse(pc) : [0,0,0,h,w,0,w,h];

    var dragged=false;
    c.canvas.addEventListener('mousedown',function(e){
      if(e.button==1)
        perspective=[0,0,0,h,w,0,w,h];
      else    
        dragged=true;
    });
    c.canvas.addEventListener('mouseup'  ,function(e){dragged=false;});
    c.canvas.addEventListener('mousemove',function(e){
      if(!dragged) return;
      var x=e.offsetX/c.canvas.offsetWidth*w, y=e.offsetY/c.canvas.offsetHeight*h;
      var i=0;
      if(x>w/2) i+=2;
      if(y>h/2) i+=1;
      perspective[i*2]=x;
      perspective[i*2+1]=y;  
      set_cookie('perspective',JSON.stringify(perspective));    
    });
    
    
   */
  </script>

</body>
</html>
