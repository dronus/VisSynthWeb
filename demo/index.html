<!DOCTYPE  html>
<html>
<head>
	<title>WebCamVidja Demo</title>
	<script type="text/javascript" src="../src/glfx.js"></script>
	<script src="../src/video.js"></script>
</head>
<body>
	<style>
		html,body,canvas{
			width: 100%;
			height: 100%;
			padding: 0px;
			margin: 0px;
			overflow: hidden;
			background-color: #000;
		}
	</style>

	<script>
		function get_cookie(cookie_name)
		{
			var cookie = document.cookie;
			var cookies = cookie.split(';');
			for (var i=0; i<cookies.length; ++i)
			{
				parts = cookies[i].split('=');
				if (parts[0].trim()==cookie_name)
				{
					return parts[1].trim();
				}
			}

		}

		function set_cookie(key,value)
		{
			document.cookie = key+'='+value+';path=/;expires=Thu, 1 Jan 2095 00:00:00 GMT;';
		}
	</script>
	<script>
		
		var b,c;
		
		var w=640, h=480;
		
		c = wcvj.webcam('c', {canvas: true, glfx: true});
		// c.setFilter[['ink',[0.4]]]);
		var t=0;

		var pc=get_cookie('perspective');

		var perspective=pc ? JSON.parse(pc) : [0,0,0,h,w,0,w,h];

		var dragged=false;
		c.canvas.addEventListener('mousedown',function(e){
			if(e.button==1)
				perspective=[0,0,0,h,w,0,w,h];
			else		
				dragged=true;
		});
		c.canvas.addEventListener('mouseup'  ,function(e){dragged=false;});
		c.canvas.addEventListener('mousemove',function(e){
			if(!dragged) return;
			var x=e.offsetX/c.canvas.offsetWidth*w, y=e.offsetY/c.canvas.offsetHeight*h;
			var i=0;
			if(x>w/2) i+=2;
			if(y>h/2) i+=1;
			perspective[i*2]=x;
			perspective[i*2+1]=y;	
			set_cookie('perspective',JSON.stringify(perspective));		
		});

		s=.5;

		var effects=[
//			function(t){ return ['hexagonalPixelate',[w/2,h/2,4+(Math.sin(t)+1)*2]];},
			false,
			function(t){ return ['tile',[]];},
			function(t){ return ['kaleidoscope',[Math.sin(t/2.),Math.cos(t/2.)]];},
			function(t){ return ['colorHalftone',[w/2,h/2,30,2+Math.sin(t)]];},
			function(t){ return ['unsharpMask',[3,(Math.sin(t)+1)*2]];},
			function(t){ return ['denoise',[3]];},
			function(t){ return ['swirl',[300, 246.5, 250, Math.sin(t)*1.0]];},
		];

		var special=effects[0];

		feedback=0.;

		var animation=function(){
			t+=.01;
			if(t>32*Math.PI) t-=32*Math.PI;
			// var x1=w*.4, x2=w-x1, y1=h*.4, y2=h-y1;
			var chain=[['vibrance',[.8]]];
			if(feedback) chain.push(['feedbackOut',[feedback]]);
			chain.push(['perspective',[[0,0,0,h,w,0,w,h],perspective]]);
			if(!dragged)
			{
				if(special) chain.push(special(t));
			}
			else         chain.unshift(['grid',[]]);
			if(feedback) chain.push(['feedbackIn',[]]);
			c.setFilter(chain);
			// ['matrixWarp',[[s,0,0,s],false,true]],
			requestAnimationFrame(animation);
		};
		animation();
		document.body.appendChild(c.canvas);		

		var special_index=0;
		function prev()
		{
			special_index--;
			if(special_index<0) special_index=effects.length-1;
			special=effects[special_index];
		}
		function next()
		{
			special_index++;
			if(special_index>=effects.length) special_index=0;
			special=effects[special_index];
		}


		var interval=false;
		function stop()
		{
			if(interval) clearInterval(interval);
			interval=false;
		}
		function start(delay)
		{
			stop();
			interval=setInterval(function(){
				next();
			},delay);
		}
		function filter(name,params)
		{
			special=function(t){
				return [name,params];
			};
		}

		function fetch_script()
		{
			xmlHttp = new XMLHttpRequest();
			xmlHttp.open('GET', '/feed', true);
			xmlHttp.onreadystatechange = function () {
				if (xmlHttp.readyState == 4) {
					setTimeout(function(){
						fetch_script();
					},100);
					var js=xmlHttp.responseText;
					if(js) window.eval(js);
				}
			};
			xmlHttp.send(null);
		}
		fetch_script();
	</script>

</body>
</html>
